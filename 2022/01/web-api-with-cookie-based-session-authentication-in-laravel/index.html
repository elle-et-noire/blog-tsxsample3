<!DOCTYPE html><html lang="ja"><head><meta property="og:type" content="website"/><meta property="og:site_name" content="jamband/blog"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Laravel でクッキーベースのセッション認証を使った Web API を実装する · jamband/blog</title><meta name="description" content="Laravel をバックエンドの Web API として利用し、クッキーベースのセッション認証を使って認証関連のさまざまなアクションを実装していく。"/><meta property="og:title" content="Laravel でクッキーベースのセッション認証を使った Web API を実装する ･ jamband/blog"/><meta property="og:description" content="Laravel をバックエンドの Web API として利用し、クッキーベースのセッション認証を使って認証関連のさまざまなアクションを実装していく。"/><meta property="og:url" content="https://jamband.github.io/blog/2022/01/web-api-with-cookie-based-session-authentication-in-laravel"/><meta name="next-head-count" content="7"/><link rel="preload" href="/blog/_next/static/css/3aa9fac633eeab01.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/3aa9fac633eeab01.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog/_next/static/chunks/webpack-2c085de5ec1f2737.js" defer=""></script><script src="/blog/_next/static/chunks/framework-6e4ba497ae0c8a3f.js" defer=""></script><script src="/blog/_next/static/chunks/main-9fddf30fd6f89499.js" defer=""></script><script src="/blog/_next/static/chunks/pages/_app-12f7e1c190babb18.js" defer=""></script><script src="/blog/_next/static/chunks/919-231013f5e47261ba.js" defer=""></script><script src="/blog/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-3d0d7b5b21b5a35b.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_buildManifest.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_ssgManifest.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="flex flex-col min-h-screen"><header><nav class="fixed w-full py-3 z-20 text-center font-semibold bg-gray-800" aria-label="Header navigation"><a class="px-5 py-3 no-underline font-mono tracking-tight" href="/blog/"><span class="text-xs text-gray-100 duration-1000">jamband<!-- -->/</span><span class="text-pink-500 opacity-80 duration-1000">blog</span></a></nav></header><main class="flex-grow container mx-auto pt-28 pb-10"><div class="style_initial__lfW24" role="status"></div><div><article><header class="mb-8"><h1 class="mb-10">Laravel でクッキーベースのセッション認証を使った Web API を実装する</h1><div class="italic text-right text-sm text-gray-400"><time dateTime="2022-01-25">Jan 25, 2022</time></div></header><div class="post"><h2>はじめに</h2>
<p>Laravel をバックエンドの Web API として利用し、クッキーベースのセッション認証を使って認証関連のさまざまなアクションを実装していく。</p>
<h2>環境</h2>
<ul>
<li>PHP 8.0.x</li>
<li>Laravel 8.x</li>
<li>Google Chrome 97.x</li>
</ul>
<p>また、バックエンド (Laravel) とフロントエンド (Next.js) でアプリケーションが分かれているため、以下のようなオリジンを想定している。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">- in development environment -
Backend origin: http://localhost:8000
Frontend origin: http://localhost:3000

- in production environment -
Backend origin: https://api.example.com
Frontend origin: https://www.example.com</code></pre></div>
<h2>前提知識</h2>
<p>この記事では開発環境、本番環境ともにいわゆるクロスオリジンな通信が発生し、またクッキーベースのセッション認証を利用しているため、前提として以下の知識が必要になる。</p>
<ul>
<li><a href="https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy" target="_blank" rel="nofollow noopener noreferrer">同一オリジンポリシー</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS" target="_blank" rel="nofollow noopener noreferrer">オリジン間リソース共有 (CORS)</a></li>
<li><a href="https://web.dev/same-site-same-origin/" target="_blank" rel="nofollow noopener noreferrer">Understanding "same-site" and "same-origin"</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies" target="_blank" rel="nofollow noopener noreferrer">HTTP Cookie の使用</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie" target="_blank" rel="nofollow noopener noreferrer">Set-Cookie</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie/SameSite" target="_blank" rel="nofollow noopener noreferrer">SameSite cookies</a></li>
</ul>
<p>上記の中でも CORS はやや複雑なのだが、クロスオリジンな通信が発生するアプリケーションを扱う場合には必要不可欠なものなので、何度も読み返し、実際に検証を繰り返しつつ、覚えていくしかない。</p>
<p>また Cookie も同様に各 Web ブラウザによって Set-Cookie ヘッダーの属性のデフォルト値に差異があったり、特定の環境下で異なる動作をしたり、セキュリティ関連のみに収まらず最近ではプライバシー関連での問題があったりと、わりと扱いにくくなってきたものの、これもまた各 Web ブラウザの動向を追いつつ、対応状況を把握しつつ、柔軟に対応していく他ない。</p>
<h2>デモアプリケーション</h2>
<p>今回の記事を書くにあたって、以下の 2 つのデモアプリケーションを作成した。</p>
<ul>
<li><a href="https://github.com/jamband/api.papers" target="_blank" rel="nofollow noopener noreferrer">jamband/api.papers</a></li>
<li><a href="https://github.com/jamband/papers-next" target="_blank" rel="nofollow noopener noreferrer">jamband/papers-next</a></li>
</ul>
<p>Papers 自体はログインして自分しか見れないメモを残すだけの簡単なアプリケーションで、api.papers は Laravel を利用したバックエンド Web API、papers-next は Next.js を使ったフロントエンド側のアプリケーションになる。認証関連のアクションでメールを送信するなどの処理が発生するので、どこかにホスティングはせず、現状ローカル環境でのみ動作確認ができる。興味のある人は実際動かしたり、コードの読んでみたりしてほしい。</p>
<p>では、デモは一旦置いといて、実装の詳細について見ていく。</p>
<h2>Laravel 側での準備</h2>
<p>バックエンドのアプリケーションで必要になるのは以下:</p>
<ul>
<li><a href="https://github.com/laravel/framework" target="_blank" rel="nofollow noopener noreferrer">laravel/framework</a></li>
<li><a href="https://github.com/fruitcake/laravel-cors" target="_blank" rel="nofollow noopener noreferrer">fruitcake/laravel-cors</a></li>
</ul>
<p>最初は <a href="https://github.com/laravel/sanctum" target="_blank" rel="nofollow noopener noreferrer">Laravel Sanctum</a> も使っていたのだが、今回の環境ではいらないと思い途中で使うのをやめた。また認証関連の実装は基本的に <a href="https://github.com/laravel/breeze/tree/master/stubs/api" target="_blank" rel="nofollow noopener noreferrer">Laravel Breeze の api</a> を参考にしている。ただ Laravel Breeze はスターターキット的なものなので Composer でインストールとかはせず、あくまで中身のコードを参考にしている程度。</p>
<h2>CORS の設定</h2>
<p>開発時を想定して再度オリジンを確認する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">- in development environment -
Backend origin: http://localhost:8000 (with Laravel)
Frontend origin: http://localhost:3000 (with Next.js)</code></pre></div>
<p>今回の場合はポート (8000 と 3000) が違うため、Web ブラウザがクロスオリジンであると判定する。これは <a href="https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest" target="_blank" rel="nofollow noopener noreferrer">XMLHttpRequest</a> や <a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="nofollow noopener noreferrer">Fetch API</a> を介してフロントエンド側がバックエンド側と通信を行おうとした場合に Web ブラウザが自動的に判定する。</p>
<p>さらにこの通信時に Web ブラウザはバックエンド側に対して「Origin」という HTTP ヘッダーを含める。これも Web ブラウザが自動的に行う。なので、バックエンド側ではこの Origin の値を最初に検証し、その後で諸々の設定を行う。</p>
<p>まず許可する Origin を HTTP の Access-Control-Allow-Origin ヘッダーを使って明示する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Origin: http://localhost:3000</code></pre></div>
<p>Laravel で <a href="https://github.com/fruitcake/laravel-cors" target="_blank" rel="nofollow noopener noreferrer">fruitcake/laravel-cors</a> を使っている場合は以下のようになる (環境変数名はわかりやすければなんでもいい):</p>
<div class="remark-highlight"><pre data-file=".env" class="language-shell"><code class="language-shell"><span class="token assign-left variable">FRONTEND_ORIGIN</span><span class="token operator">=</span>http://localhost:3000
</code></pre></div>
<div class="remark-highlight"><pre data-file="config/cors.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'paths'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_origins'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FRONTEND_ORIGIN'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>本番環境では FRONTEND_ORIGIN という環境変数をどこかしらで設定する必要がある:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">FRONTEND_ORIGIN=https://www.example.com</code></pre></div>
<p>allowed_origins の値は配列になっていて複数指定できるが、これは以下のようなことをやっているわけではないので注意:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Origin: http://localhost:3000,http://localhost:3001</code></pre></div>
<p>allowed_origins はあくまで許可するオリジンのリストであって、Web ブラウザから送られてくる Origin ヘッダーの値を見て、許可するオリジンリストにマッチするものがあればレスポンスとして以下のようなヘッダーを含める、ということをやっている:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Origin: http://localhost:3000

もしくは
Access-Control-Allow-Origin: http://localhost:3001</code></pre></div>
<p>Access-Control-Allow-Origin ヘッダーにはオリジンの複数指定はできない。また * (アスタリスク) も指定できるが、今回のようなセッション認証の場合、クッキーを扱うことになり * (アスタリスク) を指定した場合に Web ブラウザがエラーを返すので使えない。というより * (アスタリスク) はあらゆるすべてのオリジンからのアクセスを許可する値なので基本的には使ってはいけない (null も同様)。</p>
<p>次は Access-Control-Allow-Methods ヘッダーの値を明示する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS,PATCH</code></pre></div>
<p>これはフロントエンド側がバックエンド側にアクセスする際に使う HTTP のリクエストメソッドを指定する。これはカンマ区切りで複数指定できる。Access-Control-Allow-Origin ヘッダーと同様に値として * (アスタリスク) を指定できるが、条件によっては意味のない * というメソッドとして扱われたりするので、必ず HTTP のリクエストメソッドを明示すること。</p>
<p>laravel-cors を使っている場合は以下:</p>
<div class="remark-highlight"><pre data-file="config/cors.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'paths'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_origins'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FRONTEND_ORIGIN'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_methods'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PUT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PATCH'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>allowed_methods では配列で指定することになる。注意としては allowed_methods で POST を許可した場合、フロントエンド側は PUT 及び DELETE も許可されることなる。これは動作としてはややこしいが Laravel が依存している Symfony の特定のコンポーネントがそういう動作をするので仕方ない。自分はそれでもフロントエンド側が使うすべての HTTP リクエストメソッドを明示的に指定する。その方がわかりやすいので。</p>
<p>また、この記事では PUT, DELETE, PATCH などの HTTP リクエストメソッドを使っているが、そもそも RESTful ではない、いわゆる外部に公開することはない特定のアプリケーションに対して閉じられた Web API を作成する場合は、PUT, DELETE, PATCH などは使わず、GET, POST のみでも全然かまわない。ただどちらかに統一はするべき。</p>
<p>さて、この Access-Control-Allow-Methods ヘッダーはフロントエンド側が <a href="https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest" target="_blank" rel="nofollow noopener noreferrer">XMLHttpRequest</a> や <a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="nofollow noopener noreferrer">Fetch API</a> を介してバックエンド側にアクセスしようとした際に Web ブラウザが自動的に生成する Access-Control-Request-Method ヘッダーに対してのレスポンスヘッダーであることに注意する。そしてこの Access-Control-Allow-Methods は特定のリクエストの際に使われるものであって、すべてのリクエストに対して無条件で返されるものではない、ということをとりあえず覚えておく。</p>
<p>次は Access-Control-Allow-Headers ヘッダーの値を明示する。これはフロントエンド側がバックエンド側にアクセスする際に使う HTTP ヘッダー一覧を指定する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Headers: Accept,Content-Type,X-XSRF-TOKEN</code></pre></div>
<p>上記以外のヘッダーが含まれたアクセスがあった場合 Web ブラウザはエラーを返し、バックエンド側との通信はその時点で遮断される。</p>
<p>laravel-cors を使っている場合は以下:</p>
<div class="remark-highlight"><pre data-file="config/cors.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'paths'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_origins'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FRONTEND_ORIGIN'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_methods'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PUT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PATCH'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_headers'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'Accept'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Origin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'X-XSRF-TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>生の Access-Control-Allow-Headers ヘッダーとの違いは Origin ヘッダーも指定しているところ。これは <a href="https://github.com/fruitcake/laravel-cors#configuration" target="_blank" rel="nofollow noopener noreferrer">laravel-cors</a> の README に書いてあるのでとりあえず付け足しておく。また、Accept と Content-Type ヘッダーは常に許可されているヘッダーなので明示する必要はないのだが、ヘッダーの値によっては許可されたりされなかったりするというあいまいな条件があるため、すべて明示したほうが無難。X-XSRF-TOKEN ヘッダーは CSRF 対策として使われる Laravel 特有のヘッダーでフロントエンド側からバックエンド側に <a href="https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest" target="_blank" rel="nofollow noopener noreferrer">XMLHttpRequest</a> や <a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="nofollow noopener noreferrer">Fetch API</a> を介して POST リクエストをする際などに必要になってくる。</p>
<p>また、この Access-Control-Allow-Headers ヘッダーでも * (アスタリスク) を指定できるが、他のヘッダーと同様に使うことはできるが、できるかぎり使わないこと。</p>
<p>あと、Access-Control-Allow-Headers も Access-Control-Allow-Methods と同様に Access-Control-Request-Headers を含むリクエストの際のレスポンスヘッダーであり、特定のリクエストの際に使われるものであって、すべてのリクエストに対して無条件で返されるものではない。</p>
<p>次に Access-Control-Allow-Credentials ヘッダーの値を明示する。今回はクッキーベースのセッション認証を利用しているため true という値を明示する必要がある。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Access-Control-Allow-Credentials: true</code></pre></div>
<p>laravel-cors を使っている場合は以下:</p>
<div class="remark-highlight"><pre data-file="config/cors.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'paths'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_origins'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FRONTEND_ORIGIN'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_methods'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PUT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PATCH'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_headers'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'Accept'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Origin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'X-XSRF-TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'supports_credentials'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<h2>Laravel が生成する Set-Cookie ヘッダーの確認</h2>
<p>Laravel でクッキーベースのセッション認証を安全に行う場合、必要となるミドルウェアがいくつかある。</p>
<ul>
<li><a href="https://laravel.com/api/8.x/Illuminate/Cookie/Middleware/EncryptCookies.html" target="_blank" rel="nofollow noopener noreferrer">EncryptCookies</a></li>
<li><a href="https://laravel.com/api/8.x/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.html" target="_blank" rel="nofollow noopener noreferrer">AddQueuedCookiesToResponse</a></li>
<li><a href="https://laravel.com/api/8.x/Illuminate/Session/Middleware/StartSession.html" target="_blank" rel="nofollow noopener noreferrer">StartSession</a></li>
<li><a href="https://laravel.com/api/8.x/Illuminate/Session/Middleware/AuthenticateSession.html" target="_blank" rel="nofollow noopener noreferrer">AuthenticateSession</a></li>
<li><a href="https://laravel.com/api/8.x/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.html" target="_blank" rel="nofollow noopener noreferrer">VerifyCsrfToken</a></li>
</ul>
<p>上記の中の StartSession と VerifyCsrfToken ミドルウェアが独自の Set-Cookie ヘッダーを生成し、これがフロントエンド側でも重要なものになってくるので詳しく説明していく。</p>
<p>CORS の設定をした状態で、StartSession ミドルウェアが割り当てられている場合、バックエンドの Web アプリケーションがどのようなレスポンスを返すのか確認してみる。</p>
<div class="remark-highlight"><pre data-file="config/cors.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'paths'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_origins'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FRONTEND_ORIGIN'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_methods'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PUT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'PATCH'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'allowed_headers'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'Accept'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Origin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'X-XSRF-TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'supports_credentials'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="app/Http/Kernel.php" class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>EncryptCookies</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Fruitcake<span class="token punctuation">\</span>Cors<span class="token punctuation">\</span>HandleCors</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Cookie<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>AddQueuedCookiesToResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>StartSession</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Kernel</span> <span class="token keyword">extends</span> <span class="token class-name">HttpKernel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$middleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token scope">HandleCors<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$middlewareGroups</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'web'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
            <span class="token scope">EncryptCookies<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">AddQueuedCookiesToResponse<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">StartSession<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="app/Providers/RouteServiceProvider.php" class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Providers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Providers<span class="token punctuation">\</span>RouteServiceProvider</span> <span class="token keyword">as</span> ServiceProvider<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">RouteServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'web'</span><span class="token punctuation">)</span>
                <span class="token operator">-></span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token property">namespace</span><span class="token punctuation">)</span>
                <span class="token operator">-></span><span class="token function">group</span><span class="token punctuation">(</span><span class="token function">base_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'routes/web.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="routes/web.php" class="language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/foo'</span><span class="token punctuation">,</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>バックエンド側の Web API を起動 (in development environment):</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">php artisan serve</code></pre></div>
<p>簡単なフロントエンド側のスクリプトを書く:</p>
<div class="remark-highlight"><pre data-file="/path/to/frontend/index.html" class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/foo"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre></div>
<p>フロントエンド側のアプリケーションを PHP のビルトインウェブサーバで起動 (in development environment):</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">cd /path/to/frontend
php -S localhost:3000 -t .</code></pre></div>
<p>Web ブラウザで <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> にアクセスし、Developer Tools の Console 画面で正常にレスポンスが返ってきてるかを確認する。</p>
<p>ここからは Web ブラウザの Developer Tools による細かな説明になる。この記事では Google Chrome (英語版) を使って進めていく。</p>
<p>Developer Tools の Application タブを選択し Storage 項目の Cookies を展開して <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> を選択する。すると現状 <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> に保存してあるクッキーの一覧が表示されるので、存在する場合はすべて削除しておく (右クリックして Clear で削除できる)。その状態で Network タブに移動しブラウザをリロードする。ブラウザが読み込んだファイル一覧が表示されると思うので、その中から foo を選択する。タブがさらにいくつか表示されると思うので、その中から Headers を選択する。ここでリクエストヘッダーとレスポンスヘッダーの詳細が見れる。</p>
<p>まずリクエストヘッダーから見ていく。この foo はフロントエンド側の index.html ファイル内の fetch() メソッドを使いバックエンド側に GET リクエストした際に Web ブラウザが自動的に生成するリクエストヘッダー。いろいろな種類のヘッダーがあるが、その中でも注目すべきは「Origin」ヘッダー。このヘッダーは「クロスオリジンなリクエストの際は必ず Web ブラウザが自動生成する」。</p>
<p>続いてレスポンスヘッダー。フロントエンド側から fetch() メソッドを使ってバックエンド側にリクエストがあった場合に、バックエンド側が Web ブラウザに返すヘッダーであり、ここでもいろいろな種類のヘッダーが表示されていると思うが、その中でも注目すべきは Access-Control-* と Set-Cookie の 2 つ。Access-Control-* はバックエンド側で CORS の設定時に指定した値が表示されているはず。ただ、Access-Control-Allow-Methods と Access-Control-Allow-Headers ヘッダーは存在しない。なぜかは後で説明する。</p>
<p>Set-Cookie には xxx_session という名前のクッキーが存在する。これはセッション情報をやりとりするときに使われるもの。Laravel の StartSession ミドルウェアが /foo ルートに割り当てられている場合に自動的に生成される。</p>
<p>Set-Cookie の属性についても見ていく:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Set-Cookie: xxx_session=eyJpdiI...; expires=...; Max-Age=7200; path=/; httponly; samesite=lax</code></pre></div>
<p>Expires 属性はクッキーの有効期限。Laravel を使っている場合は config/session.php の lifetime で調整することができる。</p>
<p>Max-Age 属性はクッキーの期限切れまでの秒数。Laravel を使っている場合は Session の lifetime が秒数に変換され設定される。Expires と Max-Age 属性が両方設定されている場合、Max-Age が優先される。</p>
<p>Domain 属性はクッキーの送信先のドメインを指定する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">...; Domain=example.com; ...</code></pre></div>
<p>そして上記のような指定がされていた場合、サブドメイン (例えば foo.example.com, bar.example.com) にもクッキーが送信される。また、Domain 属性が省略された場合はクッキーを発行したドメインにのみクッキーが送信され、サブドメインには送信されなくなる。</p>
<p>Laravel を使っている場合は config/session.php の domain で設定する:</p>
<div class="remark-highlight"><pre data-file="config/session.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string single-quoted-string">'domain'</span> <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SESSION_DOMAIN'</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>これは変更せず、そのままにしておく。.env にも SESSION_DOMAIN はなく、つまりデフォルトでは Domain 属性は省略される。この記事では開発環境時のバックエンド/フロントエンドともに localhost という同じホストを使っているため結果的にクッキーは送信されるようになっている。ただ本番環境ではどこかしらに Domain 属性を指定した環境変数を用意しておく必要がある。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">SESSION_DOMAIN=example.com</code></pre></div>
<p>Secure 属性は HTTPS プロトコルで通信が行われた場合にのみクッキーを送信する。なので本番環境は必ず付ける。開発環境ではやっかいなので自分は省略している。</p>
<p>Laravel を使っている場合は config/session.php で設定する。</p>
<div class="remark-highlight"><pre data-file=".env" class="language-shell"><code class="language-shell"><span class="token assign-left variable">SESSION_SECURE_COOKIE</span><span class="token operator">=</span>false
</code></pre></div>
<div class="remark-highlight"><pre data-file="config/session.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string single-quoted-string">'secure'</span> <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SESSION_SECURE_COOKIE'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>これで結果的に本番環境では SESSION_SECURE_COOKIE という環境変数を用意しなくても Secure 属性が付く。</p>
<p>また、Secure 属性については Web ブラウザによって挙動が違うみたいで、開発環境時にスキームが http:// であろうと https:// であろうと 「localhost」 というホストを使っている場合、現時点の最新の Google Chrome, Firefox では Secure 属性が付いていたとしても、本来送信されないであろうクッキーが送信されるようになっている。ただ Safari (バージョン 15.2 現在) では送信されないようになっている (こういう挙動は混乱を招く)。</p>
<p>このような理由から開発環境では自分は Secure 属性を付けず、上記のような設定にし、本番環境では自動で付くような感じにしている。</p>
<p>HttpOnly 属性は JavaScript からクッキーにアクセスさせないようにする属性。XSS 攻撃を軽減することができるので認証関連を扱うクッキーには必ず付けておく。</p>
<p>Laravel では config/session.php で設定する。</p>
<div class="remark-highlight"><pre data-file="config/session.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'http_only'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>デフォルトでは上記のようになっているはず。このままにしておく。</p>
<p>最後に SameSite 属性。Web ブラウザで A というサイトにアクセスしたとする。A サイトはレスポンスの一部としてクッキーを発行したとする。Web ブラウザは A サイトから発行されたクッキーを Web ブラウザ内に保存する。で、再度同じ Web ブラウザを使って A サイトにアクセスしたとする。その際 Web ブラウザは過去に保存した A サイトから発行されたクッキーを Cookie リクエストヘッダーを用いて「自動的に」 A サイトに送信する。</p>
<p>この仕組みのおかげで何か再度手続きをしなくてもログイン状態を維持できたりするわけだが、この「Web ブラウザが Cookie リクエストヘッダーを用いて自動的に送信するクッキー」というのは悪用される恐れがあるため、その送信先を「限定する」というのが SameSite 属性で指定できる。</p>
<p>値としては Strict, Lax, None のいずれかを用いる。</p>
<p>Laravel では config/session.php で設定する。</p>
<div class="remark-highlight"><pre data-file="config/session.php" class="language-php"><code class="language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string single-quoted-string">'same_site'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'lax'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>デフォルトは Lax なのでこの記事ではそのままを使う。他のフレームワークでもおそらくここ数年のアップデートでデフォルト値が Lax に設定されていると思われる。クッキーを扱う場合わりと重要な値なのでしっかり確認しておく。</p>
<p>また、この SameSite 属性は省略でき、その場合は Web ブラウザのデフォルト値が採用されるわけだが、各 Web ブラウザによって値が違ったりするので、できる限り明示したほうがいい。</p>
<p>Strict, Lax, None の値の違いについては細かな部分で検証しきれていないためここでは省略する。とりあえず MDN の <a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie" target="_blank" rel="nofollow noopener noreferrer">Set-Cookie</a> とかを読みつつ検証する他ない。おそらくだいたいのアプリケーションは Lax で問題ないと思うが、いろんな歴史を持った、いろんなアプリケーションがあるので、その中で適切だと思う値を指定する。</p>
<p>続いて Laravel のもう一つのミドルウェアである <a href="https://laravel.com/api/8.x/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.html" target="_blank" rel="nofollow noopener noreferrer">VerifyCsrfToken</a> を見ていく。</p>
<div class="remark-highlight"><pre data-file="app/Http/Kernel.php" class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>EncryptCookies</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>VerifyCsrfToken</span><span class="token punctuation">;</span> <span class="token comment">// add</span>
<span class="token keyword">use</span> <span class="token package">Fruitcake<span class="token punctuation">\</span>Cors<span class="token punctuation">\</span>HandleCors</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Cookie<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>AddQueuedCookiesToResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>StartSession</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Kernel</span> <span class="token keyword">extends</span> <span class="token class-name">HttpKernel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$middleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token scope">HandleCors<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$middlewareGroups</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'web'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
            <span class="token scope">EncryptCookies<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">AddQueuedCookiesToResponse<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">StartSession<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">VerifyCsrfToken<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">// add</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Web ブラウザで <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> のクッキーを削除して、再度 <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> にアクセスし、Network タブから foo を選択し、リクエスト/レスポンスヘッダーを確認する。</p>
<p>xxx_session の他に XSRF-TOKEN というものがあるかと思う。これは VerifyCsrfToken が /foo ルートに割り当てられている場合に Laravel が自動的に生成するもの。CSRF 対策の一つとして利用される。ちなみに XSRF-TOKEN クッキーはフロントエンド側にて JavaScript で取得し加工した後にバックエンド側に送信する POST リクエスト等に含める必要があるため HttpOnly 属性は持っていない。</p>
<p>最後にフロントエンド側からバックエンドの /foo ルートに対して GET リクエストし、その後に /bar ルートに対して POST リクエストしてみる。</p>
<div class="remark-highlight"><pre data-file="routes/web.php" class="language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/foo'</span><span class="token punctuation">,</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/bar'</span><span class="token punctuation">,</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'hello'</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'hello from backend.'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="/path/to/frontend/index.html" class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/foo"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token property-access">ok</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> cookies <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">cookie</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cookie <span class="token operator">=</span> cookies<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> _<span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">"XSRF-TOKEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> csrfToken <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/bar"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"X-XSRF-TOKEN"</span><span class="token operator">:</span> csrfToken<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"hello"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre></div>
<p>Web ブラウザに保存されているクッキーを削除し、再度 <a href="http://localhost:3000" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000</a> にアクセスする。</p>
<p>Console タブを選択すると以下のレスポンスボディが返ってきているかと思う:</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">{</span>message: <span class="token string">'hello from backend.'</span><span class="token punctuation">}</span>
</code></pre></div>
<p>注目すべきところはまず Network タブ。foo は 1 つだが、bar は 2 つ表示されているはず。これは Web ブラウザがバックエンド側の /bar に対して 2 回リクエストしたことを示す。フロントエンド側のコードでは /bar に対してのリクエストは 1 回しかしていないはずなのに。</p>
<p>Status が 204 の bar を選択しリクエスト/レスポンスヘッダーを見てみる。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">- Request Headers -
Access-Control-Request-Headers: content-type,x-xsrf-token
Access-Control-Request-Method: POST
Origin: http://localhost:3000
...

- Response Headers -
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: accept, content-type, origin, x-xsrf-token
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Max-Age: 0
...</code></pre></div>
<p>これは何が発生したかというと、フロントエンド側がバックエンド側の /bar ルートに対してリクエストしようとした内容が複雑であると Web ブラウザが判断し、実際のリクエストをする前に、いくつかのリクエストヘッダーを使って Web ブラウザがバックエンドに対して安全なリクエストであるかを確認している。</p>
<p>これは Web ブラウザが自動的に行う。今回の例ではリクエストヘッダーの Content-Type が application/json であること、また、X-XSRF-TOKEN というリクエストヘッダーが存在すること、が発生要因として挙げられる。</p>
<p>ちなみにこのリクエストをプリフライトリクエストと呼ぶ。Options メソッドで送信され、安全であると判断されれば HTTP のレスポンスとして通常 204 が返ってくる。バックエンド側が許可していないリクエストヘッダーなどが使われていた場合、Web ブラウザがエラーを吐き通信はその時点で遮断される。</p>
<p>プリフライトリクエストが発生する条件はやや複雑なのでここでは省略する。<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E5%8D%98%E7%B4%94%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88" target="_blank" rel="nofollow noopener noreferrer">CORS 単純リクエスト</a> などが参考になる。</p>
<h2>ログインアクションの実装</h2>
<p>では、実際にログインアクションを実装してみる。ルートとしては以下 の 3 つを作成する:</p>
<ol>
<li>GET /csrf-cookie</li>
<li>POST /login</li>
<li>GET /user</li>
</ol>
<p>1 は CSRF 対策用のトークンを生成するアクション、2 はログインアクション、3 はログイン済みのユーザの名前を返すアクション。</p>
<p>Composer の create-project などで Laravel のプロジェクトが作成されていて、データベースの設定、マイグレーションの実行などが完了していると仮定して話を進めていく。また、試験用として以下の値を持ったユーザを 1 件追加しておく (password は Hash ファサードの make メソッドなどを使いハッシュ化する)。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">name: foo
email: foo@example.com
password: foofoofoo</code></pre></div>
<p>まずはルーティング (本当はコントローラを用意したり、ログインの処理ももう少しちゃんとする必要がある):</p>
<div class="remark-highlight"><pre data-file="routes/web.php" class="language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Auth</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/csrf-cookie'</span><span class="token punctuation">,</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">noContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token scope">Auth<span class="token punctuation">::</span></span><span class="token function">attempt</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">regenerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">noContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'auth.failed'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'guest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span> <span class="token operator">=></span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token property">name</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'auth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="app/Providers/RouteServiceProvider.php" class="language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Providers<span class="token punctuation">\</span>RouteServiceProvider</span> <span class="token keyword">as</span> ServiceProvider<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">RouteServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'web'</span><span class="token punctuation">)</span>
                <span class="token operator">-></span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token property">namespace</span><span class="token punctuation">)</span>
                <span class="token operator">-></span><span class="token function">group</span><span class="token punctuation">(</span><span class="token function">base_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'routes/web.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ミドルウェアは以下:</p>
<div class="remark-highlight"><pre data-file="app/Http/Kernel.php" class="language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>Authenticate</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>EncryptCookies</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>RedirectIfAuthenticated</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>VerifyCsrfToken</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Fruitcake<span class="token punctuation">\</span>Cors<span class="token punctuation">\</span>HandleCors</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Cookie<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>AddQueuedCookiesToResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Kernel</span> <span class="token keyword">as</span> HttpKernel<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>AuthenticateSession</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>StartSession</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Kernel</span> <span class="token keyword">extends</span> <span class="token class-name">HttpKernel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$middleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token scope">HandleCors<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$middlewareGroups</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'web'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
            <span class="token scope">EncryptCookies<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">AddQueuedCookiesToResponse<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">StartSession<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">AuthenticateSession<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token scope">VerifyCsrfToken<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'auth'</span> <span class="token operator">=></span> <span class="token scope">Authenticate<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'guest'</span> <span class="token operator">=></span> <span class="token scope">RedirectIfAuthenticated<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>フロントエンド側:</p>
<div class="remark-highlight"><pre data-file="/path/to/frontend/index.html" class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/csrf-cookie"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token property-access">ok</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> cookies <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">cookie</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"; "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cookie <span class="token operator">=</span> cookies<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> _<span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">"XSRF-TOKEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> csrfToken <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/login"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"X-XSRF-TOKEN"</span><span class="token operator">:</span> csrfToken<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">"foo@example.com"</span><span class="token punctuation">,</span>
          <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">"foofoofoo"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token property-access">ok</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/user"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> res<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre></div>
<p>/csrf-token に GET リクエストするといくつかのクッキーが Web ブラウザに保存される。それを取得した後 CSRF 対策用のクッキーとログインに必要な body を含めて /login に POST リクエストする。最後に /user に GET リクエストする。結果として Web ブラウザの Console 画面に以下が表示される。</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">{</span>name:<span class="token string">'foo'</span><span class="token punctuation">}</span>
</code></pre></div>
<p>以上がおおまかではあるが、ログインの実装であり、ログインしたユーザの情報を取得する実装である。重要なのは、クッキーがいつどのように生成されて、どのような属性を持ち、どのように扱われているか。Web ブラウザや CORS の性質とともにそれらを理解していないと認証関連のアクションを実装するのはわりとおっかない。</p>
<h2>テストを書く</h2>
<p>/csrf-token は body を持たないただの GET リクエストだが、ヘッダーには他のリクエストと同様に重要なクッキーの値がセットされている。そのためテストを書いて想定通りの値が返ってくるかを保証しておく。</p>
<p>というのも Laravel の重要なクッキーを送信するいくつかのミドルウェアは config/session.php に書かれている値に依存している。そのため、もし何かしらの原因でそれらの値が書き換えられた場合、想定外の何かが発生する恐れがある。</p>
<div class="remark-highlight"><pre data-file="tests/Features/CsrfCookieTest.php" class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">Tests<span class="token punctuation">\</span>Feature</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Carbon<span class="token punctuation">\</span>Carbon</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Tests<span class="token punctuation">\</span>TestCase</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CsrfCookieTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testAccessControlHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/csrf-cookie'</span><span class="token punctuation">)</span>
            <span class="token operator">-></span><span class="token function">assertHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'access-control-allow-origin'</span><span class="token punctuation">,</span> <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token property">app</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'config'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'app.cors_origins'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">-></span><span class="token function">assertHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'access-control-allow-credentials'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testCsrfCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/csrf-cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$setCookie</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token property">headers</span><span class="token operator">-></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'set-cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token variable">$setCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$setCookie</span><span class="token punctuation">;</span>

        <span class="token variable">$tokenValues</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token variable">$tokenValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertMatchesRegularExpression</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\AXSRF-TOKEN=eyJpdiI.+\z/'</span><span class="token punctuation">,</span> <span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'expires='</span><span class="token operator">.</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">expires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$tokenValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Max-Age=7200'</span><span class="token punctuation">,</span> <span class="token variable">$tokenValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'path=/'</span><span class="token punctuation">,</span> <span class="token variable">$tokenValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'samesite=lax'</span><span class="token punctuation">,</span> <span class="token variable">$tokenValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testSessionCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/csrf-cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$setCookie</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token property">headers</span><span class="token operator">-></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'set-cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token variable">$setCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$setCookie</span><span class="token punctuation">;</span>

        <span class="token variable">$sessionValues</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertMatchesRegularExpression</span><span class="token punctuation">(</span>
            <span class="token string single-quoted-string">'/\A'</span><span class="token operator">.</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token property">app</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'config'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'app.name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'_session=eyJpdiI.+\z/'</span><span class="token punctuation">,</span>
            <span class="token variable">$session</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'expires='</span><span class="token operator">.</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">expires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Max-Age=7200'</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'path=/'</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'httponly'</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'samesite=lax'</span><span class="token punctuation">,</span> <span class="token variable">$sessionValues</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">getJson</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/csrf-cookie'</span><span class="token punctuation">)</span>
            <span class="token operator">-></span><span class="token function">assertNoContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">expires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Carbon</span><span class="token punctuation">)</span>
            <span class="token operator">-></span><span class="token function">addMinutes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token this keyword">$this</span><span class="token operator">-></span><span class="token property">app</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'config'</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.lifetime'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">-></span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'D, d-M-Y H:i:s'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">' GMT'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>どこまで細かく書くかは微妙なところだが、重要だと思う箇所はしっかりテストに書いて残しておく。</p>
<h2>Fetch API について</h2>
<p>フロントエンド側で扱う fetch() メソッドについてもいくつか確認しておく。詳しくは <a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="nofollow noopener noreferrer">Fetch の使用</a> で確認できる。</p>
<p>オプションについて:</p>
<ul>
<li>mode のデフォルト値は cors である</li>
<li>credentials のデフォルト値は same-origin である</li>
</ul>
<p>であるからして、今回のような環境 (クロスオリジンな環境) では mode は省略できる。credentials は include と明示する必要がある。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/foo"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// mode: "cors",</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>また、<a href="https://github.com/axios/axios" target="_blank" rel="nofollow noopener noreferrer">axios</a> などは Laravel が CSRF 対策として送信する XSRF-TOKEN クッキーを自動的に X-XSRF-TOKEN ヘッダーに設定する。fetch() メソッドでは手動でやらないといけない。</p>
<p>エラー処理について。fetch() も axios も非同期で処理が行われるが fetch() は通信障害 (バックエンド側のサーバがダウンしているなど) 以外はプロミスを拒否しない。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token comment">// コメントの数値は HTTP のレスポンスのステータスコード</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/foo"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">ok</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true: 200 - 299 の範囲内, false: true の範囲外</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token comment">// 200 - 599 の範囲内</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// サーバがダウンしたときなど</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

axios<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"/foo"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 200 - 299 の範囲内</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 200 - 299 の範囲外</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<p>どちらがどうとかはなんとも言えないが、このように扱うライブラリによっていろいろな差異があるのでコードを書く際は注意する。</p>
<h2>その他のアクションについて</h2>
<p>その他の認証関連のアクションについては <a href="https://github.com/jamband/api.papers" target="_blank" rel="nofollow noopener noreferrer">GitHub jamband/api.papers</a> (バックエンド) や <a href="https://github.com/jamband/papers-next" target="_blank" rel="nofollow noopener noreferrer">GitHub jamband/papers-next</a> (フロントエンド) などを参考にしてほしい。</p>
<p>また、<a href="https://github.com/laravel/breeze/tree/master/stubs/api" target="_blank" rel="nofollow noopener noreferrer">Laravel Breeze の api</a> (バックエンド) や <a href="https://github.com/laravel/breeze-next" target="_blank" rel="nofollow noopener noreferrer">Laravel Breeze Next.js Edition</a> (フロントエンド) なども参考になる (Laravel Breeze の api は Laravel Sanctum を使っているので注意)。</p>
<h2>まとめ</h2>
<p>重要なことなので再度書くが、今回は以下のような環境を想定して、クッキーベースのセッション認証について説明した。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">- in development environment -
Backend origin: http://localhost:8000
Frontend origin: http://localhost:3000

- in production environment -
Backend origin: https://api.example.com
Frontend origin: https://www.example.com</code></pre></div>
<p>上記はつまり開発/本番環境ともに「cross-origin でありながら schemeful same-site」である。その中で Web ブラウザがどのような挙動をし、フロントエンド/バックエンド側ではどのような実装が必要になるのかを示した。</p>
<p>ただ Web アプリケーションの構成はこれだけではない。以下のような same-origin な構成になる場合もあるし、トークンベースの認証を採用するかもしれない。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">- in development environment -
Backend origin: http://localhost:8000/api
Frontend origin: http://localhost:8000

- in production environment -
Backend origin: https://example.com/api
Frontend origin: https://example.com</code></pre></div>
<p>そして、どのような構成になったとしても認証関連の実装は難しいのだが、IE 11 の終末を目の前にして、この記事を書きながら、Web ブラウザについてさらにより意識を向けないといけないなぁと、改めて思った。</p>
<h2>関連リンク</h2>
<ul>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies" target="_blank" rel="nofollow noopener noreferrer">HTTP Cookie の使用</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS" target="_blank" rel="nofollow noopener noreferrer">オリジン間リソース共有 (CORS)</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="nofollow noopener noreferrer">Fetch の使用</a></li>
<li><a href="https://web.dev/fetch-metadata/" target="_blank" rel="nofollow noopener noreferrer">Protect your resources from web attacks with Fetch Metadata</a></li>
<li><a href="https://github.com/laravel/breeze" target="_blank" rel="nofollow noopener noreferrer">Laravel Breeze</a></li>
<li><a href="https://github.com/laravel/sanctum" target="_blank" rel="nofollow noopener noreferrer">Laravel Sanctum</a></li>
<li><a href="https://github.com/jamband/api.papers" target="_blank" rel="nofollow noopener noreferrer">jamband/api.papers</a></li>
<li><a href="https://github.com/jamband/papers-next" target="_blank" rel="nofollow noopener noreferrer">jamband/papers-next</a></li>
</ul>
<h2>備考</h2>
<p>この記事ではセッション情報をバックエンド側にてファイルで管理している。これは Laravel のデフォルトの設定である。アプリケーションが複数の Web サーバで構成されている場合などはその他のセッションドライバーを検討する必要があるので注意する。</p>
</div><p class="mt-16 text-center"><a class="px-5 py-3 font-semibold" href="/blog/">Home</a></p></article></div></main><div class="mb-3 font-semibold text-center text-xs text-gray-500">© 2022 Tomoki Morita</div><footer class="py-3 text-center font-semibold bg-gray-800"><nav class="text-sm" aria-label="Footer navigation"><a class="px-5 py-3" href="/blog/about/">About</a><a class="px-5 py-3" href="/blog/contact/">Contact</a></nav></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Laravel でクッキーベースのセッション認証を使った Web API を実装する","date":"2022-01-25","tags":["authentication","laravel","next"],"year":"2022","month":"01","slug":"web-api-with-cookie-based-session-authentication-in-laravel","content":"\u003ch2\u003eはじめに\u003c/h2\u003e\n\u003cp\u003eLaravel をバックエンドの Web API として利用し、クッキーベースのセッション認証を使って認証関連のさまざまなアクションを実装していく。\u003c/p\u003e\n\u003ch2\u003e環境\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003ePHP 8.0.x\u003c/li\u003e\n\u003cli\u003eLaravel 8.x\u003c/li\u003e\n\u003cli\u003eGoogle Chrome 97.x\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eまた、バックエンド (Laravel) とフロントエンド (Next.js) でアプリケーションが分かれているため、以下のようなオリジンを想定している。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e- in development environment -\nBackend origin: http://localhost:8000\nFrontend origin: http://localhost:3000\n\n- in production environment -\nBackend origin: https://api.example.com\nFrontend origin: https://www.example.com\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e前提知識\u003c/h2\u003e\n\u003cp\u003eこの記事では開発環境、本番環境ともにいわゆるクロスオリジンな通信が発生し、またクッキーベースのセッション認証を利用しているため、前提として以下の知識が必要になる。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e同一オリジンポリシー\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/CORS\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eオリジン間リソース共有 (CORS)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://web.dev/same-site-same-origin/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eUnderstanding \"same-site\" and \"same-origin\"\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eHTTP Cookie の使用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eSet-Cookie\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie/SameSite\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eSameSite cookies\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e上記の中でも CORS はやや複雑なのだが、クロスオリジンな通信が発生するアプリケーションを扱う場合には必要不可欠なものなので、何度も読み返し、実際に検証を繰り返しつつ、覚えていくしかない。\u003c/p\u003e\n\u003cp\u003eまた Cookie も同様に各 Web ブラウザによって Set-Cookie ヘッダーの属性のデフォルト値に差異があったり、特定の環境下で異なる動作をしたり、セキュリティ関連のみに収まらず最近ではプライバシー関連での問題があったりと、わりと扱いにくくなってきたものの、これもまた各 Web ブラウザの動向を追いつつ、対応状況を把握しつつ、柔軟に対応していく他ない。\u003c/p\u003e\n\u003ch2\u003eデモアプリケーション\u003c/h2\u003e\n\u003cp\u003e今回の記事を書くにあたって、以下の 2 つのデモアプリケーションを作成した。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/api.papers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ejamband/api.papers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/papers-next\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ejamband/papers-next\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePapers 自体はログインして自分しか見れないメモを残すだけの簡単なアプリケーションで、api.papers は Laravel を利用したバックエンド Web API、papers-next は Next.js を使ったフロントエンド側のアプリケーションになる。認証関連のアクションでメールを送信するなどの処理が発生するので、どこかにホスティングはせず、現状ローカル環境でのみ動作確認ができる。興味のある人は実際動かしたり、コードの読んでみたりしてほしい。\u003c/p\u003e\n\u003cp\u003eでは、デモは一旦置いといて、実装の詳細について見ていく。\u003c/p\u003e\n\u003ch2\u003eLaravel 側での準備\u003c/h2\u003e\n\u003cp\u003eバックエンドのアプリケーションで必要になるのは以下:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/laravel/framework\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003elaravel/framework\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/fruitcake/laravel-cors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003efruitcake/laravel-cors\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e最初は \u003ca href=\"https://github.com/laravel/sanctum\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Sanctum\u003c/a\u003e も使っていたのだが、今回の環境ではいらないと思い途中で使うのをやめた。また認証関連の実装は基本的に \u003ca href=\"https://github.com/laravel/breeze/tree/master/stubs/api\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Breeze の api\u003c/a\u003e を参考にしている。ただ Laravel Breeze はスターターキット的なものなので Composer でインストールとかはせず、あくまで中身のコードを参考にしている程度。\u003c/p\u003e\n\u003ch2\u003eCORS の設定\u003c/h2\u003e\n\u003cp\u003e開発時を想定して再度オリジンを確認する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e- in development environment -\nBackend origin: http://localhost:8000 (with Laravel)\nFrontend origin: http://localhost:3000 (with Next.js)\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今回の場合はポート (8000 と 3000) が違うため、Web ブラウザがクロスオリジンであると判定する。これは \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eXMLHttpRequest\u003c/a\u003e や \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eFetch API\u003c/a\u003e を介してフロントエンド側がバックエンド側と通信を行おうとした場合に Web ブラウザが自動的に判定する。\u003c/p\u003e\n\u003cp\u003eさらにこの通信時に Web ブラウザはバックエンド側に対して「Origin」という HTTP ヘッダーを含める。これも Web ブラウザが自動的に行う。なので、バックエンド側ではこの Origin の値を最初に検証し、その後で諸々の設定を行う。\u003c/p\u003e\n\u003cp\u003eまず許可する Origin を HTTP の Access-Control-Allow-Origin ヘッダーを使って明示する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Origin: http://localhost:3000\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eLaravel で \u003ca href=\"https://github.com/fruitcake/laravel-cors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003efruitcake/laravel-cors\u003c/a\u003e を使っている場合は以下のようになる (環境変数名はわかりやすければなんでもいい):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\".env\" class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token assign-left variable\"\u003eFRONTEND_ORIGIN\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ehttp://localhost:3000\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/cors.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'paths'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_origins'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'FRONTEND_ORIGIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e本番環境では FRONTEND_ORIGIN という環境変数をどこかしらで設定する必要がある:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eFRONTEND_ORIGIN=https://www.example.com\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eallowed_origins の値は配列になっていて複数指定できるが、これは以下のようなことをやっているわけではないので注意:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Origin: http://localhost:3000,http://localhost:3001\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eallowed_origins はあくまで許可するオリジンのリストであって、Web ブラウザから送られてくる Origin ヘッダーの値を見て、許可するオリジンリストにマッチするものがあればレスポンスとして以下のようなヘッダーを含める、ということをやっている:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Origin: http://localhost:3000\n\nもしくは\nAccess-Control-Allow-Origin: http://localhost:3001\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAccess-Control-Allow-Origin ヘッダーにはオリジンの複数指定はできない。また * (アスタリスク) も指定できるが、今回のようなセッション認証の場合、クッキーを扱うことになり * (アスタリスク) を指定した場合に Web ブラウザがエラーを返すので使えない。というより * (アスタリスク) はあらゆるすべてのオリジンからのアクセスを許可する値なので基本的には使ってはいけない (null も同様)。\u003c/p\u003e\n\u003cp\u003e次は Access-Control-Allow-Methods ヘッダーの値を明示する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS,PATCH\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれはフロントエンド側がバックエンド側にアクセスする際に使う HTTP のリクエストメソッドを指定する。これはカンマ区切りで複数指定できる。Access-Control-Allow-Origin ヘッダーと同様に値として * (アスタリスク) を指定できるが、条件によっては意味のない * というメソッドとして扱われたりするので、必ず HTTP のリクエストメソッドを明示すること。\u003c/p\u003e\n\u003cp\u003elaravel-cors を使っている場合は以下:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/cors.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'paths'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_origins'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'FRONTEND_ORIGIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_methods'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'GET'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PUT'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'DELETE'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'OPTIONS'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PATCH'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eallowed_methods では配列で指定することになる。注意としては allowed_methods で POST を許可した場合、フロントエンド側は PUT 及び DELETE も許可されることなる。これは動作としてはややこしいが Laravel が依存している Symfony の特定のコンポーネントがそういう動作をするので仕方ない。自分はそれでもフロントエンド側が使うすべての HTTP リクエストメソッドを明示的に指定する。その方がわかりやすいので。\u003c/p\u003e\n\u003cp\u003eまた、この記事では PUT, DELETE, PATCH などの HTTP リクエストメソッドを使っているが、そもそも RESTful ではない、いわゆる外部に公開することはない特定のアプリケーションに対して閉じられた Web API を作成する場合は、PUT, DELETE, PATCH などは使わず、GET, POST のみでも全然かまわない。ただどちらかに統一はするべき。\u003c/p\u003e\n\u003cp\u003eさて、この Access-Control-Allow-Methods ヘッダーはフロントエンド側が \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eXMLHttpRequest\u003c/a\u003e や \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eFetch API\u003c/a\u003e を介してバックエンド側にアクセスしようとした際に Web ブラウザが自動的に生成する Access-Control-Request-Method ヘッダーに対してのレスポンスヘッダーであることに注意する。そしてこの Access-Control-Allow-Methods は特定のリクエストの際に使われるものであって、すべてのリクエストに対して無条件で返されるものではない、ということをとりあえず覚えておく。\u003c/p\u003e\n\u003cp\u003e次は Access-Control-Allow-Headers ヘッダーの値を明示する。これはフロントエンド側がバックエンド側にアクセスする際に使う HTTP ヘッダー一覧を指定する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Headers: Accept,Content-Type,X-XSRF-TOKEN\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e上記以外のヘッダーが含まれたアクセスがあった場合 Web ブラウザはエラーを返し、バックエンド側との通信はその時点で遮断される。\u003c/p\u003e\n\u003cp\u003elaravel-cors を使っている場合は以下:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/cors.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'paths'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_origins'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'FRONTEND_ORIGIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_methods'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'GET'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PUT'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'DELETE'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'OPTIONS'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PATCH'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_headers'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'Accept'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Origin'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'X-XSRF-TOKEN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e生の Access-Control-Allow-Headers ヘッダーとの違いは Origin ヘッダーも指定しているところ。これは \u003ca href=\"https://github.com/fruitcake/laravel-cors#configuration\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003elaravel-cors\u003c/a\u003e の README に書いてあるのでとりあえず付け足しておく。また、Accept と Content-Type ヘッダーは常に許可されているヘッダーなので明示する必要はないのだが、ヘッダーの値によっては許可されたりされなかったりするというあいまいな条件があるため、すべて明示したほうが無難。X-XSRF-TOKEN ヘッダーは CSRF 対策として使われる Laravel 特有のヘッダーでフロントエンド側からバックエンド側に \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/XMLHttpRequest\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eXMLHttpRequest\u003c/a\u003e や \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eFetch API\u003c/a\u003e を介して POST リクエストをする際などに必要になってくる。\u003c/p\u003e\n\u003cp\u003eまた、この Access-Control-Allow-Headers ヘッダーでも * (アスタリスク) を指定できるが、他のヘッダーと同様に使うことはできるが、できるかぎり使わないこと。\u003c/p\u003e\n\u003cp\u003eあと、Access-Control-Allow-Headers も Access-Control-Allow-Methods と同様に Access-Control-Request-Headers を含むリクエストの際のレスポンスヘッダーであり、特定のリクエストの際に使われるものであって、すべてのリクエストに対して無条件で返されるものではない。\u003c/p\u003e\n\u003cp\u003e次に Access-Control-Allow-Credentials ヘッダーの値を明示する。今回はクッキーベースのセッション認証を利用しているため true という値を明示する必要がある。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eAccess-Control-Allow-Credentials: true\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003elaravel-cors を使っている場合は以下:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/cors.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'paths'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_origins'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'FRONTEND_ORIGIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_methods'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'GET'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PUT'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'DELETE'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'OPTIONS'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PATCH'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_headers'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'Accept'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Origin'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'X-XSRF-TOKEN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'supports_credentials'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eLaravel が生成する Set-Cookie ヘッダーの確認\u003c/h2\u003e\n\u003cp\u003eLaravel でクッキーベースのセッション認証を安全に行う場合、必要となるミドルウェアがいくつかある。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://laravel.com/api/8.x/Illuminate/Cookie/Middleware/EncryptCookies.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eEncryptCookies\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://laravel.com/api/8.x/Illuminate/Cookie/Middleware/AddQueuedCookiesToResponse.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eAddQueuedCookiesToResponse\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://laravel.com/api/8.x/Illuminate/Session/Middleware/StartSession.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eStartSession\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://laravel.com/api/8.x/Illuminate/Session/Middleware/AuthenticateSession.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eAuthenticateSession\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://laravel.com/api/8.x/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eVerifyCsrfToken\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e上記の中の StartSession と VerifyCsrfToken ミドルウェアが独自の Set-Cookie ヘッダーを生成し、これがフロントエンド側でも重要なものになってくるので詳しく説明していく。\u003c/p\u003e\n\u003cp\u003eCORS の設定をした状態で、StartSession ミドルウェアが割り当てられている場合、バックエンドの Web アプリケーションがどのようなレスポンスを返すのか確認してみる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/cors.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'paths'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_origins'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'FRONTEND_ORIGIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_methods'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'GET'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PUT'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'DELETE'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'OPTIONS'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'PATCH'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'allowed_headers'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'Accept'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'Origin'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'X-XSRF-TOKEN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'supports_credentials'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Kernel.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eEncryptCookies\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eFruitcake\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCors\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHandleCors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCookie\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAddQueuedCookiesToResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSession\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eStartSession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpKernel\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eHandleCors\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middlewareGroups\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'web'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eEncryptCookies\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eAddQueuedCookiesToResponse\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eStartSession\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Providers/RouteServiceProvider.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProviders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProviders\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e ServiceProvider\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eServiceProvider\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eboot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eroutes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'web'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ebase_path\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'routes/web.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"routes/web.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/foo'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'message'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'hello'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eバックエンド側の Web API を起動 (in development environment):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ephp artisan serve\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e簡単なフロントエンド側のスクリプトを書く:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/path/to/frontend/index.html\" class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n  \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ejson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003econtent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eフロントエンド側のアプリケーションを PHP のビルトインウェブサーバで起動 (in development environment):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ecd /path/to/frontend\nphp -S localhost:3000 -t .\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWeb ブラウザで \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e にアクセスし、Developer Tools の Console 画面で正常にレスポンスが返ってきてるかを確認する。\u003c/p\u003e\n\u003cp\u003eここからは Web ブラウザの Developer Tools による細かな説明になる。この記事では Google Chrome (英語版) を使って進めていく。\u003c/p\u003e\n\u003cp\u003eDeveloper Tools の Application タブを選択し Storage 項目の Cookies を展開して \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e を選択する。すると現状 \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e に保存してあるクッキーの一覧が表示されるので、存在する場合はすべて削除しておく (右クリックして Clear で削除できる)。その状態で Network タブに移動しブラウザをリロードする。ブラウザが読み込んだファイル一覧が表示されると思うので、その中から foo を選択する。タブがさらにいくつか表示されると思うので、その中から Headers を選択する。ここでリクエストヘッダーとレスポンスヘッダーの詳細が見れる。\u003c/p\u003e\n\u003cp\u003eまずリクエストヘッダーから見ていく。この foo はフロントエンド側の index.html ファイル内の fetch() メソッドを使いバックエンド側に GET リクエストした際に Web ブラウザが自動的に生成するリクエストヘッダー。いろいろな種類のヘッダーがあるが、その中でも注目すべきは「Origin」ヘッダー。このヘッダーは「クロスオリジンなリクエストの際は必ず Web ブラウザが自動生成する」。\u003c/p\u003e\n\u003cp\u003e続いてレスポンスヘッダー。フロントエンド側から fetch() メソッドを使ってバックエンド側にリクエストがあった場合に、バックエンド側が Web ブラウザに返すヘッダーであり、ここでもいろいろな種類のヘッダーが表示されていると思うが、その中でも注目すべきは Access-Control-* と Set-Cookie の 2 つ。Access-Control-* はバックエンド側で CORS の設定時に指定した値が表示されているはず。ただ、Access-Control-Allow-Methods と Access-Control-Allow-Headers ヘッダーは存在しない。なぜかは後で説明する。\u003c/p\u003e\n\u003cp\u003eSet-Cookie には xxx_session という名前のクッキーが存在する。これはセッション情報をやりとりするときに使われるもの。Laravel の StartSession ミドルウェアが /foo ルートに割り当てられている場合に自動的に生成される。\u003c/p\u003e\n\u003cp\u003eSet-Cookie の属性についても見ていく:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eSet-Cookie: xxx_session=eyJpdiI...; expires=...; Max-Age=7200; path=/; httponly; samesite=lax\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eExpires 属性はクッキーの有効期限。Laravel を使っている場合は config/session.php の lifetime で調整することができる。\u003c/p\u003e\n\u003cp\u003eMax-Age 属性はクッキーの期限切れまでの秒数。Laravel を使っている場合は Session の lifetime が秒数に変換され設定される。Expires と Max-Age 属性が両方設定されている場合、Max-Age が優先される。\u003c/p\u003e\n\u003cp\u003eDomain 属性はクッキーの送信先のドメインを指定する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e...; Domain=example.com; ...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eそして上記のような指定がされていた場合、サブドメイン (例えば foo.example.com, bar.example.com) にもクッキーが送信される。また、Domain 属性が省略された場合はクッキーを発行したドメインにのみクッキーが送信され、サブドメインには送信されなくなる。\u003c/p\u003e\n\u003cp\u003eLaravel を使っている場合は config/session.php の domain で設定する:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/session.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'domain'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'SESSION_DOMAIN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれは変更せず、そのままにしておく。.env にも SESSION_DOMAIN はなく、つまりデフォルトでは Domain 属性は省略される。この記事では開発環境時のバックエンド/フロントエンドともに localhost という同じホストを使っているため結果的にクッキーは送信されるようになっている。ただ本番環境ではどこかしらに Domain 属性を指定した環境変数を用意しておく必要がある。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eSESSION_DOMAIN=example.com\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSecure 属性は HTTPS プロトコルで通信が行われた場合にのみクッキーを送信する。なので本番環境は必ず付ける。開発環境ではやっかいなので自分は省略している。\u003c/p\u003e\n\u003cp\u003eLaravel を使っている場合は config/session.php で設定する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\".env\" class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token assign-left variable\"\u003eSESSION_SECURE_COOKIE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003efalse\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/session.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'secure'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'SESSION_SECURE_COOKIE'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれで結果的に本番環境では SESSION_SECURE_COOKIE という環境変数を用意しなくても Secure 属性が付く。\u003c/p\u003e\n\u003cp\u003eまた、Secure 属性については Web ブラウザによって挙動が違うみたいで、開発環境時にスキームが http:// であろうと https:// であろうと 「localhost」 というホストを使っている場合、現時点の最新の Google Chrome, Firefox では Secure 属性が付いていたとしても、本来送信されないであろうクッキーが送信されるようになっている。ただ Safari (バージョン 15.2 現在) では送信されないようになっている (こういう挙動は混乱を招く)。\u003c/p\u003e\n\u003cp\u003eこのような理由から開発環境では自分は Secure 属性を付けず、上記のような設定にし、本番環境では自動で付くような感じにしている。\u003c/p\u003e\n\u003cp\u003eHttpOnly 属性は JavaScript からクッキーにアクセスさせないようにする属性。XSS 攻撃を軽減することができるので認証関連を扱うクッキーには必ず付けておく。\u003c/p\u003e\n\u003cp\u003eLaravel では config/session.php で設定する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/session.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'http_only'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eデフォルトでは上記のようになっているはず。このままにしておく。\u003c/p\u003e\n\u003cp\u003e最後に SameSite 属性。Web ブラウザで A というサイトにアクセスしたとする。A サイトはレスポンスの一部としてクッキーを発行したとする。Web ブラウザは A サイトから発行されたクッキーを Web ブラウザ内に保存する。で、再度同じ Web ブラウザを使って A サイトにアクセスしたとする。その際 Web ブラウザは過去に保存した A サイトから発行されたクッキーを Cookie リクエストヘッダーを用いて「自動的に」 A サイトに送信する。\u003c/p\u003e\n\u003cp\u003eこの仕組みのおかげで何か再度手続きをしなくてもログイン状態を維持できたりするわけだが、この「Web ブラウザが Cookie リクエストヘッダーを用いて自動的に送信するクッキー」というのは悪用される恐れがあるため、その送信先を「限定する」というのが SameSite 属性で指定できる。\u003c/p\u003e\n\u003cp\u003e値としては Strict, Lax, None のいずれかを用いる。\u003c/p\u003e\n\u003cp\u003eLaravel では config/session.php で設定する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"config/session.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'same_site'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'lax'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eデフォルトは Lax なのでこの記事ではそのままを使う。他のフレームワークでもおそらくここ数年のアップデートでデフォルト値が Lax に設定されていると思われる。クッキーを扱う場合わりと重要な値なのでしっかり確認しておく。\u003c/p\u003e\n\u003cp\u003eまた、この SameSite 属性は省略でき、その場合は Web ブラウザのデフォルト値が採用されるわけだが、各 Web ブラウザによって値が違ったりするので、できる限り明示したほうがいい。\u003c/p\u003e\n\u003cp\u003eStrict, Lax, None の値の違いについては細かな部分で検証しきれていないためここでは省略する。とりあえず MDN の \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eSet-Cookie\u003c/a\u003e とかを読みつつ検証する他ない。おそらくだいたいのアプリケーションは Lax で問題ないと思うが、いろんな歴史を持った、いろんなアプリケーションがあるので、その中で適切だと思う値を指定する。\u003c/p\u003e\n\u003cp\u003e続いて Laravel のもう一つのミドルウェアである \u003ca href=\"https://laravel.com/api/8.x/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eVerifyCsrfToken\u003c/a\u003e を見ていく。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Kernel.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eEncryptCookies\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eVerifyCsrfToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eFruitcake\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCors\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHandleCors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCookie\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAddQueuedCookiesToResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSession\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eStartSession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpKernel\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eHandleCors\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middlewareGroups\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'web'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eEncryptCookies\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eAddQueuedCookiesToResponse\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eStartSession\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eVerifyCsrfToken\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// add\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWeb ブラウザで \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e のクッキーを削除して、再度 \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e にアクセスし、Network タブから foo を選択し、リクエスト/レスポンスヘッダーを確認する。\u003c/p\u003e\n\u003cp\u003exxx_session の他に XSRF-TOKEN というものがあるかと思う。これは VerifyCsrfToken が /foo ルートに割り当てられている場合に Laravel が自動的に生成するもの。CSRF 対策の一つとして利用される。ちなみに XSRF-TOKEN クッキーはフロントエンド側にて JavaScript で取得し加工した後にバックエンド側に送信する POST リクエスト等に含める必要があるため HttpOnly 属性は持っていない。\u003c/p\u003e\n\u003cp\u003e最後にフロントエンド側からバックエンドの /foo ルートに対して GET リクエストし、その後に /bar ルートに対して POST リクエストしてみる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"routes/web.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/foo'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'message'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'hello'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003epost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/bar'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eRequest\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'message'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003einput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'message'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'hello'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'hello from backend.'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/path/to/frontend/index.html\" class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n  \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eok\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cookies \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"; \"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cookie \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e cookies\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003efind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e _\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"XSRF-TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e csrfToken \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003edecodeURIComponent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecookie\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"=\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n      \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/bar\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003emethod\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"Content-Type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"X-XSRF-TOKEN\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e csrfToken\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003emessage\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hello\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ejson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003econtent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWeb ブラウザに保存されているクッキーを削除し、再度 \u003ca href=\"http://localhost:3000\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttp://localhost:3000\u003c/a\u003e にアクセスする。\u003c/p\u003e\n\u003cp\u003eConsole タブを選択すると以下のレスポンスボディが返ってきているかと思う:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003emessage: \u003cspan class=\"token string\"\u003e'hello from backend.'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e注目すべきところはまず Network タブ。foo は 1 つだが、bar は 2 つ表示されているはず。これは Web ブラウザがバックエンド側の /bar に対して 2 回リクエストしたことを示す。フロントエンド側のコードでは /bar に対してのリクエストは 1 回しかしていないはずなのに。\u003c/p\u003e\n\u003cp\u003eStatus が 204 の bar を選択しリクエスト/レスポンスヘッダーを見てみる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e- Request Headers -\nAccess-Control-Request-Headers: content-type,x-xsrf-token\nAccess-Control-Request-Method: POST\nOrigin: http://localhost:3000\n...\n\n- Response Headers -\nAccess-Control-Allow-Credentials: true\nAccess-Control-Allow-Headers: accept, content-type, origin, x-xsrf-token\nAccess-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH\nAccess-Control-Allow-Origin: http://localhost:3000\nAccess-Control-Max-Age: 0\n...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれは何が発生したかというと、フロントエンド側がバックエンド側の /bar ルートに対してリクエストしようとした内容が複雑であると Web ブラウザが判断し、実際のリクエストをする前に、いくつかのリクエストヘッダーを使って Web ブラウザがバックエンドに対して安全なリクエストであるかを確認している。\u003c/p\u003e\n\u003cp\u003eこれは Web ブラウザが自動的に行う。今回の例ではリクエストヘッダーの Content-Type が application/json であること、また、X-XSRF-TOKEN というリクエストヘッダーが存在すること、が発生要因として挙げられる。\u003c/p\u003e\n\u003cp\u003eちなみにこのリクエストをプリフライトリクエストと呼ぶ。Options メソッドで送信され、安全であると判断されれば HTTP のレスポンスとして通常 204 が返ってくる。バックエンド側が許可していないリクエストヘッダーなどが使われていた場合、Web ブラウザがエラーを吐き通信はその時点で遮断される。\u003c/p\u003e\n\u003cp\u003eプリフライトリクエストが発生する条件はやや複雑なのでここでは省略する。\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#%E5%8D%98%E7%B4%94%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eCORS 単純リクエスト\u003c/a\u003e などが参考になる。\u003c/p\u003e\n\u003ch2\u003eログインアクションの実装\u003c/h2\u003e\n\u003cp\u003eでは、実際にログインアクションを実装してみる。ルートとしては以下 の 3 つを作成する:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eGET /csrf-cookie\u003c/li\u003e\n\u003cli\u003ePOST /login\u003c/li\u003e\n\u003cli\u003eGET /user\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e1 は CSRF 対策用のトークンを生成するアクション、2 はログインアクション、3 はログイン済みのユーザの名前を返すアクション。\u003c/p\u003e\n\u003cp\u003eComposer の create-project などで Laravel のプロジェクトが作成されていて、データベースの設定、マイグレーションの実行などが完了していると仮定して話を進めていく。また、試験用として以下の値を持ったユーザを 1 件追加しておく (password は Hash ファサードの make メソッドなどを使いハッシュ化する)。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ename: foo\nemail: foo@example.com\npassword: foofoofoo\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまずはルーティング (本当はコントローラを用意したり、ログインの処理ももう少しちゃんとする必要がある):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"routes/web.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAuth\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/csrf-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enoContent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003epost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/login'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eRequest\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token scope\"\u003eAuth\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eattempt\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003einput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eregenerate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enoContent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'message'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003e__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'auth.failed'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e422\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'guest'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eRequest\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'name'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$request\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003euser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'auth'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Providers/RouteServiceProvider.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProviders\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e ServiceProvider\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eServiceProvider\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eboot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eroutes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'web'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ebase_path\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'routes/web.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eミドルウェアは以下:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Kernel.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAuthenticate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eEncryptCookies\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRedirectIfAuthenticated\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eVerifyCsrfToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eFruitcake\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCors\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHandleCors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCookie\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAddQueuedCookiesToResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e HttpKernel\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSession\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eAuthenticateSession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSession\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eStartSession\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpKernel\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eHandleCors\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middlewareGroups\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'web'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eEncryptCookies\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eAddQueuedCookiesToResponse\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eStartSession\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eAuthenticateSession\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eVerifyCsrfToken\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$routeMiddleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'auth'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token scope\"\u003eAuthenticate\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'guest'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token scope\"\u003eRedirectIfAuthenticated\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eフロントエンド側:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/path/to/frontend/index.html\" class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n  \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/csrf-cookie\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eok\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cookies \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"; \"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cookie \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e cookies\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003efind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e _\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"XSRF-TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e csrfToken \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003edecodeURIComponent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecookie\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"=\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n      \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/login\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003emethod\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"Content-Type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"X-XSRF-TOKEN\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e csrfToken\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eemail\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo@example.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003epassword\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foofoofoo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eok\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/user\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n              \u003cspan class=\"token literal-property property\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ejson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003econtent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e/csrf-token に GET リクエストするといくつかのクッキーが Web ブラウザに保存される。それを取得した後 CSRF 対策用のクッキーとログインに必要な body を含めて /login に POST リクエストする。最後に /user に GET リクエストする。結果として Web ブラウザの Console 画面に以下が表示される。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003ename:\u003cspan class=\"token string\"\u003e'foo'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e以上がおおまかではあるが、ログインの実装であり、ログインしたユーザの情報を取得する実装である。重要なのは、クッキーがいつどのように生成されて、どのような属性を持ち、どのように扱われているか。Web ブラウザや CORS の性質とともにそれらを理解していないと認証関連のアクションを実装するのはわりとおっかない。\u003c/p\u003e\n\u003ch2\u003eテストを書く\u003c/h2\u003e\n\u003cp\u003e/csrf-token は body を持たないただの GET リクエストだが、ヘッダーには他のリクエストと同様に重要なクッキーの値がセットされている。そのためテストを書いて想定通りの値が返ってくるかを保証しておく。\u003c/p\u003e\n\u003cp\u003eというのも Laravel の重要なクッキーを送信するいくつかのミドルウェアは config/session.php に書かれている値に依存している。そのため、もし何かしらの原因でそれらの値が書き換えられた場合、想定外の何かが発生する恐れがある。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"tests/Features/CsrfCookieTest.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eTests\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFeature\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eCarbon\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCarbon\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eTests\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eTestCase\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eCsrfCookieTest\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTestCase\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003etestAccessControlHeaders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetJson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/csrf-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'access-control-allow-origin'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003eapp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'config'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'app.cors_origins'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'access-control-allow-credentials'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'true'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003etestCsrfCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$response\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetJson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/csrf-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$response\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'set-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$token\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eexplode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'; '\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$token\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertMatchesRegularExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/\\AXSRF-TOKEN=eyJpdiI.+\\z/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$token\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'expires='\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eexpires\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'Max-Age=7200'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'path=/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'samesite=lax'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$tokenValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003etestSessionCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$response\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetJson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/csrf-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$response\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'set-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$session\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$setCookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eexplode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'; '\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$session\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertMatchesRegularExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"token string single-quoted-string\"\u003e'/\\A'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estr_replace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'.'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003estrtolower\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003eapp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'config'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'app.name'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'_session=eyJpdiI.+\\z/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token variable\"\u003e$session\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'expires='\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eexpires\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'Max-Age=7200'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'path=/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'httponly'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertContains\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'samesite=lax'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$sessionValues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003etestContent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetJson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/csrf-cookie'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eassertNoContent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eexpires\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCarbon\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddMinutes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword type-casting\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003eapp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'config'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'session.lifetime'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eformat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'D, d-M-Y H:i:s'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e' GMT'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eどこまで細かく書くかは微妙なところだが、重要だと思う箇所はしっかりテストに書いて残しておく。\u003c/p\u003e\n\u003ch2\u003eFetch API について\u003c/h2\u003e\n\u003cp\u003eフロントエンド側で扱う fetch() メソッドについてもいくつか確認しておく。詳しくは \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eFetch の使用\u003c/a\u003e で確認できる。\u003c/p\u003e\n\u003cp\u003eオプションについて:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emode のデフォルト値は cors である\u003c/li\u003e\n\u003cli\u003ecredentials のデフォルト値は same-origin である\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eであるからして、今回のような環境 (クロスオリジンな環境) では mode は省略できる。credentials は include と明示する必要がある。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// mode: \"cors\",\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"include\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまた、\u003ca href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eaxios\u003c/a\u003e などは Laravel が CSRF 対策として送信する XSRF-TOKEN クッキーを自動的に X-XSRF-TOKEN ヘッダーに設定する。fetch() メソッドでは手動でやらないといけない。\u003c/p\u003e\n\u003cp\u003eエラー処理について。fetch() も axios も非同期で処理が行われるが fetch() は通信障害 (バックエンド側のサーバがダウンしているなど) 以外はプロミスを拒否しない。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// コメントの数値は HTTP のレスポンスのステータスコード\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eok\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// true: 200 - 299 の範囲内, false: true の範囲外\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003estatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 200 - 599 の範囲内\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword control-flow\"\u003ecatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eerror\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// サーバがダウンしたときなど\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\naxios\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 200 - 299 の範囲内\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword control-flow\"\u003ecatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eerror\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 200 - 299 の範囲外\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eどちらがどうとかはなんとも言えないが、このように扱うライブラリによっていろいろな差異があるのでコードを書く際は注意する。\u003c/p\u003e\n\u003ch2\u003eその他のアクションについて\u003c/h2\u003e\n\u003cp\u003eその他の認証関連のアクションについては \u003ca href=\"https://github.com/jamband/api.papers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub jamband/api.papers\u003c/a\u003e (バックエンド) や \u003ca href=\"https://github.com/jamband/papers-next\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub jamband/papers-next\u003c/a\u003e (フロントエンド) などを参考にしてほしい。\u003c/p\u003e\n\u003cp\u003eまた、\u003ca href=\"https://github.com/laravel/breeze/tree/master/stubs/api\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Breeze の api\u003c/a\u003e (バックエンド) や \u003ca href=\"https://github.com/laravel/breeze-next\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Breeze Next.js Edition\u003c/a\u003e (フロントエンド) なども参考になる (Laravel Breeze の api は Laravel Sanctum を使っているので注意)。\u003c/p\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003e重要なことなので再度書くが、今回は以下のような環境を想定して、クッキーベースのセッション認証について説明した。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e- in development environment -\nBackend origin: http://localhost:8000\nFrontend origin: http://localhost:3000\n\n- in production environment -\nBackend origin: https://api.example.com\nFrontend origin: https://www.example.com\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e上記はつまり開発/本番環境ともに「cross-origin でありながら schemeful same-site」である。その中で Web ブラウザがどのような挙動をし、フロントエンド/バックエンド側ではどのような実装が必要になるのかを示した。\u003c/p\u003e\n\u003cp\u003eただ Web アプリケーションの構成はこれだけではない。以下のような same-origin な構成になる場合もあるし、トークンベースの認証を採用するかもしれない。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e- in development environment -\nBackend origin: http://localhost:8000/api\nFrontend origin: http://localhost:8000\n\n- in production environment -\nBackend origin: https://example.com/api\nFrontend origin: https://example.com\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eそして、どのような構成になったとしても認証関連の実装は難しいのだが、IE 11 の終末を目の前にして、この記事を書きながら、Web ブラウザについてさらにより意識を向けないといけないなぁと、改めて思った。\u003c/p\u003e\n\u003ch2\u003e関連リンク\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eHTTP Cookie の使用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/CORS\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eオリジン間リソース共有 (CORS)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eFetch の使用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://web.dev/fetch-metadata/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eProtect your resources from web attacks with Fetch Metadata\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/laravel/breeze\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Breeze\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/laravel/sanctum\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel Sanctum\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/api.papers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ejamband/api.papers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/papers-next\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ejamband/papers-next\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e備考\u003c/h2\u003e\n\u003cp\u003eこの記事ではセッション情報をバックエンド側にてファイルで管理している。これは Laravel のデフォルトの設定である。アプリケーションが複数の Web サーバで構成されている場合などはその他のセッションドライバーを検討する必要があるので注意する。\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2022","month":"01","slug":"web-api-with-cookie-based-session-authentication-in-laravel"},"buildId":"sAih_aVMsyb7DL7MOSAgG","assetPrefix":"/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>