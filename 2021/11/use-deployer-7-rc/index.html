<!DOCTYPE html><html lang="ja"><head><meta property="og:type" content="website"/><meta property="og:site_name" content="jamband/blog"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Deployer の 7.0 RC 版を使ってみる · jamband/blog</title><meta name="description" content="PHP のバージョン 8.1 が 25 Nov 2021 にリリースされ、7.3 系のセキュリティーサポートも 6 Dec 2021 で終了する。それに従って、自分が管理している "/><meta property="og:title" content="Deployer の 7.0 RC 版を使ってみる ･ jamband/blog"/><meta property="og:description" content="PHP のバージョン 8.1 が 25 Nov 2021 にリリースされ、7.3 系のセキュリティーサポートも 6 Dec 2021 で終了する。それに従って、自分が管理している "/><meta property="og:url" content="https://jamband.github.io/blog/2021/11/use-deployer-7-rc"/><meta name="next-head-count" content="7"/><link rel="preload" href="/blog-tsxsample3/_next/static/css/3aa9fac633eeab01.css" as="style"/><link rel="stylesheet" href="/blog-tsxsample3/_next/static/css/3aa9fac633eeab01.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog-tsxsample3/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog-tsxsample3/_next/static/chunks/webpack-d4274a9fa7773368.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/framework-6e4ba497ae0c8a3f.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/main-a370f1e8f0b61adf.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/pages/_app-12f7e1c190babb18.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/919-231013f5e47261ba.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-3d0d7b5b21b5a35b.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_buildManifest.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_ssgManifest.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="flex flex-col min-h-screen"><header><nav class="fixed w-full py-3 z-20 text-center font-semibold bg-gray-800" aria-label="Header navigation"><a class="px-5 py-3 no-underline font-mono tracking-tight" href="/blog-tsxsample3/"><span class="text-xs text-gray-100 duration-1000">jamband<!-- -->/</span><span class="text-pink-500 opacity-80 duration-1000">blog</span></a></nav></header><main class="flex-grow container mx-auto pt-28 pb-10"><div class="style_initial__lfW24" role="status"></div><div><article><header class="mb-8"><h1 class="mb-10">Deployer の 7.0 RC 版を使ってみる</h1><div class="italic text-right text-sm text-gray-400"><time dateTime="2021-11-28">Nov 28, 2021</time></div></header><div class="post"><h2>はじめに</h2>
<p>PHP のバージョン 8.1 が 25 Nov 2021 にリリースされ、7.3 系のセキュリティーサポートも 6 Dec 2021 で終了する。それに従って、自分が管理している PHP のパッケージなども最低バージョンを 7.4 にし 8.1 もサポートした。</p>
<p>また、自分は各言語の最新バージョンの 1 つ前のバージョンをローカルに持っておくという基本ルールがあって (例外もあるが)、Node.js の場合は LTS バージョンで区切って現時点では 14.x 系、PHP はマイナーバージョンで区切って 8.0 系になった。</p>
<p>ここで一つ問題が出てきて、PHP のデプロイツールである Deployer の現時点の最新バージョン 6.8 系が PHP の 8.x 系をサポートしていないことが判明。Deployer はローカルの Composer global で管理していて、ローカルの PHP のバージョンに依存しているので、さてどうしようかとなった。</p>
<p>Deployer は現在開発中の 7.0 系があって、そのバージョンは PHP 8.1 までサポートしている感じだったので、現時点ではまだ RC 版ではあるのだが、個人サイトで実験的に試すなら問題ないでしょ、ということで、よし使ってみようということになった。</p>
<h2>環境</h2>
<ul>
<li>PHP 8.0</li>
<li>Deloyer 7.0 RC</li>
</ul>
<h2>Deployer 6.x と 7.x の違い</h2>
<p>Deployer の 6.x 系と 7.x 系の PHP のサポートバージョンの違いは上記に書いてあるとおり。あとは <a href="https://deployer.org/docs/7.x/UPGRADE" target="_blank" rel="nofollow noopener noreferrer">Upgrade from 6.x to 7.x | Deployer</a> を見ながら対応していく。</p>
<p>公式ドキュメントを見る限り 7.x 系のドキュメントはまだまだ少なく、RC 版であることから、現時点で 6.x 系から 7.x 系への移行はまだおすすめできない。</p>
<p>そんな状況ではあるのだが、7.x 系の特徴としては以下。</p>
<ul>
<li>デプロイ用のスクリプトを YAML でも記述できるようになった</li>
<li>Deployer 専用の GitHub Action を使って git push 時にデプロイできるようになった</li>
<li>PHP のフレームワーク関連ではない recipe もコアに contrib という名前で入った</li>
</ul>
<p>その他にもいろいろあると思うが、確認しきれていない。</p>
<h2>デプロイの準備</h2>
<p>では、実際に <a href="https://plusarchive.com/" target="_blank" rel="nofollow noopener noreferrer">PlusArchive</a> という個人サイトを例にデプロイしてみる。まずは準備をする。</p>
<p>構成的には以下。</p>
<ul>
<li><a href="https://github.com/jamband/api.plusarchive.com" target="_blank" rel="nofollow noopener noreferrer">api.plusarchive.com</a> というバックエンドのプロジェクトが GitHub の public レポジトリとしてある</li>
<li><a href="https://github.com/jamband/plusarchive.com" target="_blank" rel="nofollow noopener noreferrer">plusarchive.com</a> というフロントエンドのプロジェクトが GitHub の public レポジトリとしてある</li>
<li><a href="https://plusarchive.com/" target="_blank" rel="nofollow noopener noreferrer">PlusArchive</a> はさくらの VPS で管理している</li>
<li>ssh で PlusArchive サーバと通信できるようになっている</li>
<li>Deployer は各プロジェクト毎に Composer でローカルにインストールして管理する</li>
<li>GitHub Action による自動デプロイはしない</li>
<li>デプロイ用スクリプトは PHP で記述する</li>
</ul>
<p>注意点としては、基本的に上記の 2 つのプロジェクトとは別に任意の場所にディレクトリを切って、そこでデプロイ作業を行う (リポジトリとは切り離して管理する)。</p>
<p>api.plusarchive.com のデプロイの準備 (Deployer 7.x 系はまだ RC 版なので決め打ち):</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /path/to/plusarchive.com/deploy/api.plusarchive.com
<span class="token function">composer</span> require --dev <span class="token string">"deployer/deployer:7.0.0-rc3"</span>
<span class="token function">touch</span> deploy.php
</code></pre></div>
<p>api.plusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):</p>
<div class="remark-highlight"><pre data-file="deploy.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token string single-quoted-string">'recipe/composer.php'</span><span class="token punctuation">;</span>

<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'repository'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'https://github.com/jamband/api.plusarchive.com.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'keep_releases'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'shared_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'runtime'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'writable_dirs'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'runtime'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'clear_paths'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">host</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'plusarchive.com'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'remote_user'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'labels'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'stage'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'prod'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'branch'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/xxx/xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>api.plusarchive.com は PHP の Yii Framework 2 で書かれているため shared_dirs や writable_dirs で runtime を指定する。実際はデータベースのマイグレーションコマンドなども実行する必要があるのだが、このプロジェクトでは使っていないので書いてない。</p>
<p>また Deployer は各フレームワークなどを想定して、それ専用の <a href="https://deployer.org/docs/7.x/recipe/common" target="_blank" rel="nofollow noopener noreferrer">recipe</a> を持っているので、使えそうであれば使ってもいいわけだが、プロジェクトによっていろいろ細かな構成の違いなどがあったりするので、実際問題わりと使いづらい。ただ参考にはできるのでコードの詳細を見ながら 7.x の雰囲気を味わっておく。</p>
<p>plusarchive.com のデプロイの準備:</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /path/to/plusarchive.com/deploy/plusarchive.com
<span class="token function">composer</span> require --dev <span class="token string">"deployer/deployer:7.0.0-rc3"</span>
<span class="token function">touch</span> deploy.php
</code></pre></div>
<p>plusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):</p>
<div class="remark-highlight"><pre data-file="deploy.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">Deployer</span><span class="token punctuation">;</span>

<span class="token keyword">require</span> <span class="token string single-quoted-string">'recipe/common.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token string single-quoted-string">'contrib/yarn.php'</span><span class="token punctuation">;</span>

<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'repository'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'https://github.com/jamband/plusarchive.com.git'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'keep_releases'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'clear_paths'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">host</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'plusarchive.com'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'remote_user'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xxx'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'labels'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'stage'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'prod'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'branch'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span>
    <span class="token operator">-></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'deploy_path'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/xxx/xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">after</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'deploy:update_code'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'yarn:install'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token function">task</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'yarn:build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cd {{release_path}} &#x26;&#x26; yarn build'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">task</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pm2:start'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cd {{deploy_path}} &#x26;&#x26; pm2 startOrRestart ecosystem.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">task</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'deploy'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'deploy:prepare'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'yarn:build'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'pm2:start'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'deploy:publish'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>plusarchive.com は Yarn + Nuxt + PM2 の構成なので上記のような感じになっている。</p>
<h2>デプロイする</h2>
<p>api.plusarchive.com のデプロイ用コマンドの作成:</p>
<div class="remark-highlight"><pre data-file="/path/to/plusarchive.com/deploy/api.plusarchive.com/composer.json" class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">"^8.0"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"require-dev"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"deployer/deployer"</span><span class="token operator">:</span> <span class="token string">"7.0.0-rc3"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"prepare"</span><span class="token operator">:</span> <span class="token string">"@composer install --quiet"</span><span class="token punctuation">,</span>
    <span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token string">"dep deploy stage=prod"</span><span class="token punctuation">,</span>
    <span class="token property">"releases"</span><span class="token operator">:</span> <span class="token string">"dep releases"</span><span class="token punctuation">,</span>
    <span class="token property">"unlock"</span><span class="token operator">:</span> <span class="token string">"dep deploy:unlock"</span><span class="token punctuation">,</span>
    <span class="token property">"clean"</span><span class="token operator">:</span> <span class="token string">"rm -rf vendor"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>plusarchive.com のデプロイ用コマンドの作成 (上記と全く同じ):</p>
<div class="remark-highlight"><pre data-file="/path/to/plusarchive.com/deploy/plusarchive.com/composer.json" class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">"^8.0"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"require-dev"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"deployer/deployer"</span><span class="token operator">:</span> <span class="token string">"7.0.0-rc3"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"prepare"</span><span class="token operator">:</span> <span class="token string">"@composer install --quiet"</span><span class="token punctuation">,</span>
    <span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token string">"dep deploy stage=prod"</span><span class="token punctuation">,</span>
    <span class="token property">"releases"</span><span class="token operator">:</span> <span class="token string">"dep releases"</span><span class="token punctuation">,</span>
    <span class="token property">"unlock"</span><span class="token operator">:</span> <span class="token string">"dep deploy:unlock"</span><span class="token punctuation">,</span>
    <span class="token property">"clean"</span><span class="token operator">:</span> <span class="token string">"rm -rf vendor"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>デプロイは Composer のコマンドを経由して行う。流れ的には以下。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">cd /path/to/plusarchive.com/deploy/api.plusarchive.com
composer run prepare
composer run deploy
composer run clean

cd /path/to/plusarchive.com/deploy/plusarchive.com
composer run prepare
composer run deploy
composer run clean</code></pre></div>
<p>何かしらの問題があり途中で止まった場合 lock されるので unlock コマンドを用意しておき、デプロイされたプロジェクトの履歴を見るために releases も用意しておく。</p>
<h2>まとめ</h2>
<p>わりと雑で少しめんどくさいデプロイ方法ではあるが、問題なく動いてはいるのでとりあえず良しとする。</p>
<p>今回のデプロイ方法はただの一例であって、このような方法ではなく、もっと洗練された方法があると思うので、Deployer の 7.x の安定版のリリースを待ちつつ、少しずつ改善していきたい。</p>
<h2>関連リンク</h2>
<ul>
<li><a href="https://deployer.org/" target="_blank" rel="nofollow noopener noreferrer">Deployer</a></li>
</ul>
</div><p class="mt-16 text-center"><a class="px-5 py-3 font-semibold" href="/blog-tsxsample3/">Home</a></p></article></div></main><div class="mb-3 font-semibold text-center text-xs text-gray-500">© 2022 Tomoki Morita</div><footer class="py-3 text-center font-semibold bg-gray-800"><nav class="text-sm" aria-label="Footer navigation"><a class="px-5 py-3" href="/blog-tsxsample3/about/">About</a><a class="px-5 py-3" href="/blog-tsxsample3/contact/">Contact</a></nav></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Deployer の 7.0 RC 版を使ってみる","date":"2021-11-28","tags":["deployment","php"],"year":"2021","month":"11","slug":"use-deployer-7-rc","content":"\u003ch2\u003eはじめに\u003c/h2\u003e\n\u003cp\u003ePHP のバージョン 8.1 が 25 Nov 2021 にリリースされ、7.3 系のセキュリティーサポートも 6 Dec 2021 で終了する。それに従って、自分が管理している PHP のパッケージなども最低バージョンを 7.4 にし 8.1 もサポートした。\u003c/p\u003e\n\u003cp\u003eまた、自分は各言語の最新バージョンの 1 つ前のバージョンをローカルに持っておくという基本ルールがあって (例外もあるが)、Node.js の場合は LTS バージョンで区切って現時点では 14.x 系、PHP はマイナーバージョンで区切って 8.0 系になった。\u003c/p\u003e\n\u003cp\u003eここで一つ問題が出てきて、PHP のデプロイツールである Deployer の現時点の最新バージョン 6.8 系が PHP の 8.x 系をサポートしていないことが判明。Deployer はローカルの Composer global で管理していて、ローカルの PHP のバージョンに依存しているので、さてどうしようかとなった。\u003c/p\u003e\n\u003cp\u003eDeployer は現在開発中の 7.0 系があって、そのバージョンは PHP 8.1 までサポートしている感じだったので、現時点ではまだ RC 版ではあるのだが、個人サイトで実験的に試すなら問題ないでしょ、ということで、よし使ってみようということになった。\u003c/p\u003e\n\u003ch2\u003e環境\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003ePHP 8.0\u003c/li\u003e\n\u003cli\u003eDeloyer 7.0 RC\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eDeployer 6.x と 7.x の違い\u003c/h2\u003e\n\u003cp\u003eDeployer の 6.x 系と 7.x 系の PHP のサポートバージョンの違いは上記に書いてあるとおり。あとは \u003ca href=\"https://deployer.org/docs/7.x/UPGRADE\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eUpgrade from 6.x to 7.x | Deployer\u003c/a\u003e を見ながら対応していく。\u003c/p\u003e\n\u003cp\u003e公式ドキュメントを見る限り 7.x 系のドキュメントはまだまだ少なく、RC 版であることから、現時点で 6.x 系から 7.x 系への移行はまだおすすめできない。\u003c/p\u003e\n\u003cp\u003eそんな状況ではあるのだが、7.x 系の特徴としては以下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eデプロイ用のスクリプトを YAML でも記述できるようになった\u003c/li\u003e\n\u003cli\u003eDeployer 専用の GitHub Action を使って git push 時にデプロイできるようになった\u003c/li\u003e\n\u003cli\u003ePHP のフレームワーク関連ではない recipe もコアに contrib という名前で入った\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eその他にもいろいろあると思うが、確認しきれていない。\u003c/p\u003e\n\u003ch2\u003eデプロイの準備\u003c/h2\u003e\n\u003cp\u003eでは、実際に \u003ca href=\"https://plusarchive.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ePlusArchive\u003c/a\u003e という個人サイトを例にデプロイしてみる。まずは準備をする。\u003c/p\u003e\n\u003cp\u003e構成的には以下。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/api.plusarchive.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eapi.plusarchive.com\u003c/a\u003e というバックエンドのプロジェクトが GitHub の public レポジトリとしてある\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/plusarchive.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eplusarchive.com\u003c/a\u003e というフロントエンドのプロジェクトが GitHub の public レポジトリとしてある\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://plusarchive.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ePlusArchive\u003c/a\u003e はさくらの VPS で管理している\u003c/li\u003e\n\u003cli\u003essh で PlusArchive サーバと通信できるようになっている\u003c/li\u003e\n\u003cli\u003eDeployer は各プロジェクト毎に Composer でローカルにインストールして管理する\u003c/li\u003e\n\u003cli\u003eGitHub Action による自動デプロイはしない\u003c/li\u003e\n\u003cli\u003eデプロイ用スクリプトは PHP で記述する\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e注意点としては、基本的に上記の 2 つのプロジェクトとは別に任意の場所にディレクトリを切って、そこでデプロイ作業を行う (リポジトリとは切り離して管理する)。\u003c/p\u003e\n\u003cp\u003eapi.plusarchive.com のデプロイの準備 (Deployer 7.x 系はまだ RC 版なので決め打ち):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e /path/to/plusarchive.com/deploy/api.plusarchive.com\n\u003cspan class=\"token function\"\u003ecomposer\u003c/span\u003e require --dev \u003cspan class=\"token string\"\u003e\"deployer/deployer:7.0.0-rc3\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003etouch\u003c/span\u003e deploy.php\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eapi.plusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"deploy.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eDeployer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003erequire\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'recipe/composer.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'repository'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'https://github.com/jamband/api.plusarchive.com.git'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'keep_releases'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'shared_dirs'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'runtime'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'writable_dirs'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'runtime'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'clear_paths'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003ehost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'plusarchive.com'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'remote_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'port'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e123\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'labels'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'stage'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'prod'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'branch'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'main'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'deploy_path'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'/xxx/xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eapi.plusarchive.com は PHP の Yii Framework 2 で書かれているため shared_dirs や writable_dirs で runtime を指定する。実際はデータベースのマイグレーションコマンドなども実行する必要があるのだが、このプロジェクトでは使っていないので書いてない。\u003c/p\u003e\n\u003cp\u003eまた Deployer は各フレームワークなどを想定して、それ専用の \u003ca href=\"https://deployer.org/docs/7.x/recipe/common\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003erecipe\u003c/a\u003e を持っているので、使えそうであれば使ってもいいわけだが、プロジェクトによっていろいろ細かな構成の違いなどがあったりするので、実際問題わりと使いづらい。ただ参考にはできるのでコードの詳細を見ながら 7.x の雰囲気を味わっておく。\u003c/p\u003e\n\u003cp\u003eplusarchive.com のデプロイの準備:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e /path/to/plusarchive.com/deploy/plusarchive.com\n\u003cspan class=\"token function\"\u003ecomposer\u003c/span\u003e require --dev \u003cspan class=\"token string\"\u003e\"deployer/deployer:7.0.0-rc3\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003etouch\u003c/span\u003e deploy.php\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eplusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"deploy.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eDeployer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003erequire\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'recipe/common.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003erequire\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'contrib/yarn.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'repository'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'https://github.com/jamband/plusarchive.com.git'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'keep_releases'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'clear_paths'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003ehost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'plusarchive.com'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'remote_user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'port'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e123\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'labels'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'stage'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'prod'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'branch'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'main'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'deploy_path'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'/xxx/xxx'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eafter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'deploy:update_code'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'yarn:install'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\n\u003cspan class=\"token function\"\u003etask\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'yarn:build'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'cd {{release_path}} \u0026#x26;\u0026#x26; yarn build'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003etask\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'pm2:start'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'cd {{deploy_path}} \u0026#x26;\u0026#x26; pm2 startOrRestart ecosystem.config.js'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003etask\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'deploy'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'deploy:prepare'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'yarn:build'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'pm2:start'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e'deploy:publish'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eplusarchive.com は Yarn + Nuxt + PM2 の構成なので上記のような感じになっている。\u003c/p\u003e\n\u003ch2\u003eデプロイする\u003c/h2\u003e\n\u003cp\u003eapi.plusarchive.com のデプロイ用コマンドの作成:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/path/to/plusarchive.com/deploy/api.plusarchive.com/composer.json\" class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"require\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"php\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^8.0\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"require-dev\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"deployer/deployer\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"7.0.0-rc3\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"prepare\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"@composer install --quiet\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep deploy stage=prod\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"releases\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep releases\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"unlock\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep deploy:unlock\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"clean\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rm -rf vendor\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eplusarchive.com のデプロイ用コマンドの作成 (上記と全く同じ):\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/path/to/plusarchive.com/deploy/plusarchive.com/composer.json\" class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"require\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"php\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^8.0\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"require-dev\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"deployer/deployer\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"7.0.0-rc3\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"prepare\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"@composer install --quiet\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep deploy stage=prod\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"releases\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep releases\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"unlock\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dep deploy:unlock\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"clean\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rm -rf vendor\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eデプロイは Composer のコマンドを経由して行う。流れ的には以下。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ecd /path/to/plusarchive.com/deploy/api.plusarchive.com\ncomposer run prepare\ncomposer run deploy\ncomposer run clean\n\ncd /path/to/plusarchive.com/deploy/plusarchive.com\ncomposer run prepare\ncomposer run deploy\ncomposer run clean\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e何かしらの問題があり途中で止まった場合 lock されるので unlock コマンドを用意しておき、デプロイされたプロジェクトの履歴を見るために releases も用意しておく。\u003c/p\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eわりと雑で少しめんどくさいデプロイ方法ではあるが、問題なく動いてはいるのでとりあえず良しとする。\u003c/p\u003e\n\u003cp\u003e今回のデプロイ方法はただの一例であって、このような方法ではなく、もっと洗練された方法があると思うので、Deployer の 7.x の安定版のリリースを待ちつつ、少しずつ改善していきたい。\u003c/p\u003e\n\u003ch2\u003e関連リンク\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://deployer.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eDeployer\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2021","month":"11","slug":"use-deployer-7-rc"},"buildId":"-mSpNxblT_7qXLgt3RP1-","assetPrefix":"/blog-tsxsample3","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>