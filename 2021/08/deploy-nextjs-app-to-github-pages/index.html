<!DOCTYPE html><html lang="ja"><head><meta property="og:type" content="website"/><meta property="og:site_name" content="jamband/blog"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Next.js で作ったブログを GitHub Pages にデプロイする · jamband/blog</title><meta name="description" content="静的なウェブサイトを公開できる GitHub Pages を利用して、Next.js で作ったブログを GitHub Pages にデプロイするやり方を書いていく。"/><meta property="og:title" content="Next.js で作ったブログを GitHub Pages にデプロイする ･ jamband/blog"/><meta property="og:description" content="静的なウェブサイトを公開できる GitHub Pages を利用して、Next.js で作ったブログを GitHub Pages にデプロイするやり方を書いていく。"/><meta property="og:url" content="https://jamband.github.io/blog/2021/08/deploy-nextjs-app-to-github-pages"/><meta name="next-head-count" content="7"/><link rel="preload" href="/blog-tsxsample3/_next/static/css/3aa9fac633eeab01.css" as="style"/><link rel="stylesheet" href="/blog-tsxsample3/_next/static/css/3aa9fac633eeab01.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog-tsxsample3/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog-tsxsample3/_next/static/chunks/webpack-d4274a9fa7773368.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/framework-6e4ba497ae0c8a3f.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/main-a370f1e8f0b61adf.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/pages/_app-12f7e1c190babb18.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/919-231013f5e47261ba.js" defer=""></script><script src="/blog-tsxsample3/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-3d0d7b5b21b5a35b.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_buildManifest.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_ssgManifest.js" defer=""></script><script src="/blog-tsxsample3/_next/static/-mSpNxblT_7qXLgt3RP1-/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="flex flex-col min-h-screen"><header><nav class="fixed w-full py-3 z-20 text-center font-semibold bg-gray-800" aria-label="Header navigation"><a class="px-5 py-3 no-underline font-mono tracking-tight" href="/blog-tsxsample3/"><span class="text-xs text-gray-100 duration-1000">jamband<!-- -->/</span><span class="text-pink-500 opacity-80 duration-1000">blog</span></a></nav></header><main class="flex-grow container mx-auto pt-28 pb-10"><div class="style_initial__lfW24" role="status"></div><div><article><header class="mb-8"><h1 class="mb-10">Next.js で作ったブログを GitHub Pages にデプロイする</h1><div class="italic text-right text-sm text-gray-400"><time dateTime="2021-08-01">Aug 01, 2021</time></div></header><div class="post"><h2>はじめに</h2>
<p>静的なウェブサイトを公開できる GitHub Pages を利用して、Next.js で作ったブログを GitHub Pages にデプロイするやり方を書いていく。</p>
<h2>環境</h2>
<ul>
<li>GitHub Pages</li>
<li>GitHub Actions</li>
<li>Yarn 1.22.x</li>
<li>Next.js 11.0.x</li>
</ul>
<h2>大まかな流れ</h2>
<ol>
<li>Next.js でブログを作成する</li>
<li>GitHub Pages にデプロイするための調整を Next.js 側で行う</li>
<li>GitHub Actions のワークフローを作成する</li>
<li>GitHub にリポジトリを作成する</li>
<li>ローカルリポジトリを GitHub に push する</li>
<li>デプロイ用のワークフローが正常に動作していることを確認する</li>
<li>ブログサイトにアクセスして正常にデプロイされているか確認する</li>
</ol>
<h2>Next.js でブログを作成する</h2>
<p>自分は Next.js 公式の <a href="https://github.com/vercel/next.js/tree/canary/examples/blog-starter-typescript" target="_blank" rel="nofollow noopener noreferrer">examples/blog-starter-typescript</a> を参考にして作った。記事を Markdown で管理し、リポジトリに含めるやり方。メリットはすべてのものがリポジトリ内で完結している点。デメリットは記事の細かな操作を自分で一から書かないといけない点。もちろんいくつかのライブラリを使って楽はできるが、JavaScript や Node.js に慣れていないとわりとめんどくさい。</p>
<p>機能的に最小限で記事数も少ないのであれば「すべてをリポジトリに含めるやり方」がいいかもしれない。記事数が多く、機能もそこそこ充実させたい場合は Headless CMS を検討する。</p>
<p>Next.js の ISR (Incremental Static Regeneration) や WordPress の利用などまで考えてしまうと話がややこしくなるので、ここでは省略する。</p>
<h2>GitHub Pages にデプロイするための調整を Next.js 側で行う</h2>
<p>GitHub Pages はデフォルトでは <a href="https://jekyllrb.com/" target="_blank" rel="nofollow noopener noreferrer">Jekyll</a> を使ってサイトを構築しようとする (<em>Aug 01, 2021</em> 現在)。今回は Jekyll ではなく Next.js を使うので、もろもろの調整が必要になる。</p>
<p>まず、空の .nojekyll というファイルを public ディレクトリ以下に置いておく。これで GitHub Pages のデフォルトの動作を変更することができる。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">cd /path/to/project
touch public/.nojekyll</code></pre></div>
<p>次に next.config.js で以下の設定を行う。</p>
<div class="remark-highlight"><pre data-file="next.config.js" class="language-js"><code class="language-js"><span class="token comment">// repository_name はそれぞれの値に置き換える</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">basePath</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">GITHUB_ACTIONS</span> <span class="token operator">?</span> <span class="token string">"/repository_name"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token literal-property property">trailingSlash</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p><a href="https://nextjs.org/docs/api-reference/next.config.js/basepath" target="_blank" rel="nofollow noopener noreferrer">basePath</a> は Next.js 9.5 で追加されたものだが、上記のように設定することによって、ローカル環境と GitHub Actions で実行されたビルドとで basePath の値を調整することができる。例えば <a href="https://nextjs.org/docs/api-reference/next/link" target="_blank" rel="nofollow noopener noreferrer">next/link</a> の href が /about なリンクがページのどこかにあった場合、値は以下のようになる。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">ローカル環境
http://localhost:3000/about/

GitHub Pages
https://username.github.io/repository_name/about/</code></pre></div>
<p>ちなみに GITHUB_ACTIONS というのは GitHub Actions が持っているデフォルトの環境変数の一つ。一覧は <a href="https://docs.github.com/ja/actions/reference/environment-variables#default-environment-variables" target="_blank" rel="nofollow noopener noreferrer">デフォルトの環境変数</a> で確認できる。ローカル環境と GitHub Actions で実行されたものを区別できるものなら特になんでもいいが、一番わかりやすそうな GITHUB_ACTIONS を今回は利用した。</p>
<p><a href="https://nextjs.org/docs/api-reference/next.config.js/trailing-slash" target="_blank" rel="nofollow noopener noreferrer">trailingSlash</a> も Next.js 9.5 で追加されたものだが、本番環境用にビルド・デプロイしたアプリケーション (Node.js サーバを必要としないもの) 上で、直接 /about にアクセスした場合などに 404 になるのを防ぐことができるので true にしておく。</p>
<h2>GitHub Actions のワークフローを作成する</h2>
<p>ここでは GitHub Pages にアプリケーションをデプロイする処理を書いていく。これを書くことによって、git push 時に特定のワークフローを実行することができ、ビルド・デプロイを自動化できる。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">cd /path/to/project
mkdir -p .github/workflows
touch .github/workflows/deploy.yml</code></pre></div>
<div class="remark-highlight"><pre data-file=".github/workflows/deploy.yml" class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to GitHub Pages

<span class="token comment"># main ブランチ の push 時にこのワークフローを実行する</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
 <span class="token key atrule">push</span><span class="token punctuation">:</span>
   <span class="token key atrule">branches</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> main

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
 <span class="token key atrule">build</span><span class="token punctuation">:</span>
   <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span>

   <span class="token key atrule">steps</span><span class="token punctuation">:</span>
     <span class="token comment"># main ブランチを取得する</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
       <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

     <span class="token comment"># Node.js のセットアップをする</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup Node
       <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2
       <span class="token key atrule">with</span><span class="token punctuation">:</span>
         <span class="token key atrule">node-version</span><span class="token punctuation">:</span> 14.x
         <span class="token key atrule">cache</span><span class="token punctuation">:</span> yarn

     <span class="token comment"># パッケージをインストールする</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
       <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile

     <span class="token comment"># ビルドする</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build
       <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn build

     <span class="token comment"># GitHub Pages にデプロイする</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy
       <span class="token key atrule">uses</span><span class="token punctuation">:</span> peaceiris/actions<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>pages@v3
       <span class="token key atrule">with</span><span class="token punctuation">:</span>
         <span class="token key atrule">github_token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
         <span class="token key atrule">publish_dir</span><span class="token punctuation">:</span> out
</code></pre></div>
<p>GitHub で個人アクセストークンを作成しておく (<a href="https://docs.github.com/ja/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="nofollow noopener noreferrer">個人アクセストークンを使用する</a>)。</p>
<p>OS や actions、Node.js のバージョンは現在自分が最適だと思うものを指定する。また actions などはバージョンが上がると書き方が変わったりするので注意。以下でそれぞれ確認することができる。</p>
<ul>
<li><a href="https://github.com/actions/checkout" target="_blank" rel="nofollow noopener noreferrer">actions/checkout</a></li>
<li><a href="https://github.com/actions/setup-node" target="_blank" rel="nofollow noopener noreferrer">actions/setup-node</a></li>
<li><a href="https://github.com/peaceiris/actions-gh-pages" target="_blank" rel="nofollow noopener noreferrer">peaceiris/actions-gh-pages</a></li>
</ul>
<p>ビルドコマンドを package.json に書く。</p>
<div class="remark-highlight"><pre data-file="package.json" class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"next dev"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"next build &#x26;&#x26; next export"</span><span class="token punctuation">,</span>
    ...
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>next export が実行されるとプロジェクトルートに out ディレクトリが作成され、そこにすべての本番環境用のファイルが配置される。つまり GitHub Pages 上でのルートになる。</p>
<p>また、ローカル環境やステージング環境でも next export して動作確認をする場合があるので、 out ディレクトリも Git の管理下から除外しておく。</p>
<div class="remark-highlight"><pre data-file=".gitignore" class="language-unknown"><code class="language-unknown">/.next
/node_modules
/out</code></pre></div>
<h2>GitHub にリポジトリを作成する</h2>
<p>もろもろの作成・設定を終えたら GitHub にリポジトリを作成する。カスタムドメインを使用しない場合リポジトリ名がそのままドキュメントルートになるので注意する。以下のような感じ。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">username と repository_name はそれぞれの値に置き換える
https://username.github.io/repository_name/</code></pre></div>
<h2>ローカルリポジトリを GitHub に push する</h2>
<p>username と repository_name はそれぞれの値に書き換える。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">cd /path/to/project
git init
git add .
git status
git commit
git remote add origin git@github.com:username/repository_name.git
git branch -M main
git push -u origin main</code></pre></div>
<h2>デプロイ用のワークフローが正常に動作していることを確認する</h2>
<p>GitHub で作成したリポジトリページのブランチ切替ボタンをクリックして gh-pages ブランチが作られていることを確認する。gh-pages ブランチがある場合、作成した GitHub Actions のワークフローが正常に動作していることになる (この処理は <a href="https://github.com/peaceiris/actions-gh-pages" target="_blank" rel="nofollow noopener noreferrer">peaceiris/actions-gh-pages</a> がやっている) 。</p>
<p>次に Settings > Pages とたどり、GitHub Pages の設定項目の Source の Branch を gh-pages にし Save する。</p>
<h2>ブログサイトにアクセスして正常にデプロイされているか確認する</h2>
<p>以下の URL にアクセスして動作などを確認する。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">username と repository_name はそれぞれの値に置き換える
https://username.github.io/repository_name/</code></pre></div>
<h2>まとめ</h2>
<p>このサイトは <em>Aug 01, 2021</em> 現在 Next.js + GitHub Pages の組み合わせで動いている。Next.js で作成したものを GitHub Pages にデプロイするにあたっていろいろ調べてみたが、わりとハマりどころがあってやや苦労した。</p>
<p>ただ、Next.js の理解も深まり、GitHub Pages の特徴、 GitHub Actions のあれこれを学べたので結果的には収穫が多かった。以下はこのサイトのリポジトリ。</p>
<ul>
<li><a href="https://github.com/jamband/blog" target="_blank" rel="nofollow noopener noreferrer">GitHub: jamband/blog</a></li>
</ul>
<h2>関連リンク</h2>
<ul>
<li><a href="https://docs.github.com/en/pages/getting-started-with-github-pages/about-github-pages" target="_blank" rel="nofollow noopener noreferrer">About GitHub Pages</a></li>
<li><a href="https://docs.github.com/en/actions" target="_blank" rel="nofollow noopener noreferrer">GitHub Actions</a></li>
<li><a href="https://nextjs.org/" target="_blank" rel="nofollow noopener noreferrer">Next.js</a></li>
</ul>
</div><p class="mt-16 text-center"><a class="px-5 py-3 font-semibold" href="/blog-tsxsample3/">Home</a></p></article></div></main><div class="mb-3 font-semibold text-center text-xs text-gray-500">© 2022 Tomoki Morita</div><footer class="py-3 text-center font-semibold bg-gray-800"><nav class="text-sm" aria-label="Footer navigation"><a class="px-5 py-3" href="/blog-tsxsample3/about/">About</a><a class="px-5 py-3" href="/blog-tsxsample3/contact/">Contact</a></nav></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Next.js で作ったブログを GitHub Pages にデプロイする","date":"2021-08-01","tags":["deployment","github","next"],"year":"2021","month":"08","slug":"deploy-nextjs-app-to-github-pages","content":"\u003ch2\u003eはじめに\u003c/h2\u003e\n\u003cp\u003e静的なウェブサイトを公開できる GitHub Pages を利用して、Next.js で作ったブログを GitHub Pages にデプロイするやり方を書いていく。\u003c/p\u003e\n\u003ch2\u003e環境\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eGitHub Pages\u003c/li\u003e\n\u003cli\u003eGitHub Actions\u003c/li\u003e\n\u003cli\u003eYarn 1.22.x\u003c/li\u003e\n\u003cli\u003eNext.js 11.0.x\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e大まかな流れ\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eNext.js でブログを作成する\u003c/li\u003e\n\u003cli\u003eGitHub Pages にデプロイするための調整を Next.js 側で行う\u003c/li\u003e\n\u003cli\u003eGitHub Actions のワークフローを作成する\u003c/li\u003e\n\u003cli\u003eGitHub にリポジトリを作成する\u003c/li\u003e\n\u003cli\u003eローカルリポジトリを GitHub に push する\u003c/li\u003e\n\u003cli\u003eデプロイ用のワークフローが正常に動作していることを確認する\u003c/li\u003e\n\u003cli\u003eブログサイトにアクセスして正常にデプロイされているか確認する\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eNext.js でブログを作成する\u003c/h2\u003e\n\u003cp\u003e自分は Next.js 公式の \u003ca href=\"https://github.com/vercel/next.js/tree/canary/examples/blog-starter-typescript\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eexamples/blog-starter-typescript\u003c/a\u003e を参考にして作った。記事を Markdown で管理し、リポジトリに含めるやり方。メリットはすべてのものがリポジトリ内で完結している点。デメリットは記事の細かな操作を自分で一から書かないといけない点。もちろんいくつかのライブラリを使って楽はできるが、JavaScript や Node.js に慣れていないとわりとめんどくさい。\u003c/p\u003e\n\u003cp\u003e機能的に最小限で記事数も少ないのであれば「すべてをリポジトリに含めるやり方」がいいかもしれない。記事数が多く、機能もそこそこ充実させたい場合は Headless CMS を検討する。\u003c/p\u003e\n\u003cp\u003eNext.js の ISR (Incremental Static Regeneration) や WordPress の利用などまで考えてしまうと話がややこしくなるので、ここでは省略する。\u003c/p\u003e\n\u003ch2\u003eGitHub Pages にデプロイするための調整を Next.js 側で行う\u003c/h2\u003e\n\u003cp\u003eGitHub Pages はデフォルトでは \u003ca href=\"https://jekyllrb.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eJekyll\u003c/a\u003e を使ってサイトを構築しようとする (\u003cem\u003eAug 01, 2021\u003c/em\u003e 現在)。今回は Jekyll ではなく Next.js を使うので、もろもろの調整が必要になる。\u003c/p\u003e\n\u003cp\u003eまず、空の .nojekyll というファイルを public ディレクトリ以下に置いておく。これで GitHub Pages のデフォルトの動作を変更することができる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ecd /path/to/project\ntouch public/.nojekyll\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次に next.config.js で以下の設定を行う。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"next.config.js\" class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// repository_name はそれぞれの値に置き換える\u003c/span\u003e\nmodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ebasePath\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e process\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eGITHUB_ACTIONS\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/repository_name\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003etrailingSlash\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca href=\"https://nextjs.org/docs/api-reference/next.config.js/basepath\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ebasePath\u003c/a\u003e は Next.js 9.5 で追加されたものだが、上記のように設定することによって、ローカル環境と GitHub Actions で実行されたビルドとで basePath の値を調整することができる。例えば \u003ca href=\"https://nextjs.org/docs/api-reference/next/link\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003enext/link\u003c/a\u003e の href が /about なリンクがページのどこかにあった場合、値は以下のようになる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eローカル環境\nhttp://localhost:3000/about/\n\nGitHub Pages\nhttps://username.github.io/repository_name/about/\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eちなみに GITHUB_ACTIONS というのは GitHub Actions が持っているデフォルトの環境変数の一つ。一覧は \u003ca href=\"https://docs.github.com/ja/actions/reference/environment-variables#default-environment-variables\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eデフォルトの環境変数\u003c/a\u003e で確認できる。ローカル環境と GitHub Actions で実行されたものを区別できるものなら特になんでもいいが、一番わかりやすそうな GITHUB_ACTIONS を今回は利用した。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://nextjs.org/docs/api-reference/next.config.js/trailing-slash\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003etrailingSlash\u003c/a\u003e も Next.js 9.5 で追加されたものだが、本番環境用にビルド・デプロイしたアプリケーション (Node.js サーバを必要としないもの) 上で、直接 /about にアクセスした場合などに 404 になるのを防ぐことができるので true にしておく。\u003c/p\u003e\n\u003ch2\u003eGitHub Actions のワークフローを作成する\u003c/h2\u003e\n\u003cp\u003eここでは GitHub Pages にアプリケーションをデプロイする処理を書いていく。これを書くことによって、git push 時に特定のワークフローを実行することができ、ビルド・デプロイを自動化できる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ecd /path/to/project\nmkdir -p .github/workflows\ntouch .github/workflows/deploy.yml\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\".github/workflows/deploy.yml\" class=\"language-yml\"\u003e\u003ccode class=\"language-yml\"\u003e\u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Deploy to GitHub Pages\n\n\u003cspan class=\"token comment\"\u003e# main ブランチ の push 時にこのワークフローを実行する\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003eon\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n \u003cspan class=\"token key atrule\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token key atrule\"\u003ebranches\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e main\n\n\u003cspan class=\"token key atrule\"\u003ejobs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n \u003cspan class=\"token key atrule\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n   \u003cspan class=\"token key atrule\"\u003eruns-on\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ubuntu\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e20.04\u003c/span\u003e\n\n   \u003cspan class=\"token key atrule\"\u003esteps\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n     \u003cspan class=\"token comment\"\u003e# main ブランチを取得する\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Checkout\n       \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e actions/checkout@v2\n\n     \u003cspan class=\"token comment\"\u003e# Node.js のセットアップをする\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Setup Node\n       \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e actions/setup\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enode@v2\n       \u003cspan class=\"token key atrule\"\u003ewith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n         \u003cspan class=\"token key atrule\"\u003enode-version\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 14.x\n         \u003cspan class=\"token key atrule\"\u003ecache\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e yarn\n\n     \u003cspan class=\"token comment\"\u003e# パッケージをインストールする\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Install dependencies\n       \u003cspan class=\"token key atrule\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e yarn \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003efrozen\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003elockfile\n\n     \u003cspan class=\"token comment\"\u003e# ビルドする\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Build\n       \u003cspan class=\"token key atrule\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e yarn build\n\n     \u003cspan class=\"token comment\"\u003e# GitHub Pages にデプロイする\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Deploy\n       \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e peaceiris/actions\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003egh\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003epages@v3\n       \u003cspan class=\"token key atrule\"\u003ewith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n         \u003cspan class=\"token key atrule\"\u003egithub_token\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e secrets.GITHUB_TOKEN \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n         \u003cspan class=\"token key atrule\"\u003epublish_dir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e out\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eGitHub で個人アクセストークンを作成しておく (\u003ca href=\"https://docs.github.com/ja/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e個人アクセストークンを使用する\u003c/a\u003e)。\u003c/p\u003e\n\u003cp\u003eOS や actions、Node.js のバージョンは現在自分が最適だと思うものを指定する。また actions などはバージョンが上がると書き方が変わったりするので注意。以下でそれぞれ確認することができる。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/actions/checkout\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eactions/checkout\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/actions/setup-node\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eactions/setup-node\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/peaceiris/actions-gh-pages\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003epeaceiris/actions-gh-pages\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eビルドコマンドを package.json に書く。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"package.json\" class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"dev\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next dev\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"next build \u0026#x26;\u0026#x26; next export\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    ...\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003enext export が実行されるとプロジェクトルートに out ディレクトリが作成され、そこにすべての本番環境用のファイルが配置される。つまり GitHub Pages 上でのルートになる。\u003c/p\u003e\n\u003cp\u003eまた、ローカル環境やステージング環境でも next export して動作確認をする場合があるので、 out ディレクトリも Git の管理下から除外しておく。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\".gitignore\" class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e/.next\n/node_modules\n/out\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eGitHub にリポジトリを作成する\u003c/h2\u003e\n\u003cp\u003eもろもろの作成・設定を終えたら GitHub にリポジトリを作成する。カスタムドメインを使用しない場合リポジトリ名がそのままドキュメントルートになるので注意する。以下のような感じ。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eusername と repository_name はそれぞれの値に置き換える\nhttps://username.github.io/repository_name/\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eローカルリポジトリを GitHub に push する\u003c/h2\u003e\n\u003cp\u003eusername と repository_name はそれぞれの値に書き換える。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ecd /path/to/project\ngit init\ngit add .\ngit status\ngit commit\ngit remote add origin git@github.com:username/repository_name.git\ngit branch -M main\ngit push -u origin main\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eデプロイ用のワークフローが正常に動作していることを確認する\u003c/h2\u003e\n\u003cp\u003eGitHub で作成したリポジトリページのブランチ切替ボタンをクリックして gh-pages ブランチが作られていることを確認する。gh-pages ブランチがある場合、作成した GitHub Actions のワークフローが正常に動作していることになる (この処理は \u003ca href=\"https://github.com/peaceiris/actions-gh-pages\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003epeaceiris/actions-gh-pages\u003c/a\u003e がやっている) 。\u003c/p\u003e\n\u003cp\u003e次に Settings \u003e Pages とたどり、GitHub Pages の設定項目の Source の Branch を gh-pages にし Save する。\u003c/p\u003e\n\u003ch2\u003eブログサイトにアクセスして正常にデプロイされているか確認する\u003c/h2\u003e\n\u003cp\u003e以下の URL にアクセスして動作などを確認する。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eusername と repository_name はそれぞれの値に置き換える\nhttps://username.github.io/repository_name/\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eこのサイトは \u003cem\u003eAug 01, 2021\u003c/em\u003e 現在 Next.js + GitHub Pages の組み合わせで動いている。Next.js で作成したものを GitHub Pages にデプロイするにあたっていろいろ調べてみたが、わりとハマりどころがあってやや苦労した。\u003c/p\u003e\n\u003cp\u003eただ、Next.js の理解も深まり、GitHub Pages の特徴、 GitHub Actions のあれこれを学べたので結果的には収穫が多かった。以下はこのサイトのリポジトリ。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/blog\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub: jamband/blog\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e関連リンク\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/pages/getting-started-with-github-pages/about-github-pages\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eAbout GitHub Pages\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.github.com/en/actions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub Actions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://nextjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eNext.js\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2021","month":"08","slug":"deploy-nextjs-app-to-github-pages"},"buildId":"-mSpNxblT_7qXLgt3RP1-","assetPrefix":"/blog-tsxsample3","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>