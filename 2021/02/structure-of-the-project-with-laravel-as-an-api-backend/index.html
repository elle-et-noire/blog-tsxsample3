<!DOCTYPE html><html lang="ja"><head><meta property="og:type" content="website"/><meta property="og:site_name" content="jamband/blog"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Laravel as an API backend でのプロジェクトの構成について少しだけ考えてみる · jamband/blog</title><meta name="description" content="Laravel で Backend な API を作る機会があったので、ついでにプロジェクトの構成についても「少しだけ」 考えてみた。"/><meta property="og:title" content="Laravel as an API backend でのプロジェクトの構成について少しだけ考えてみる ･ jamband/blog"/><meta property="og:description" content="Laravel で Backend な API を作る機会があったので、ついでにプロジェクトの構成についても「少しだけ」 考えてみた。"/><meta property="og:url" content="https://jamband.github.io/blog/2021/02/structure-of-the-project-with-laravel-as-an-api-backend"/><meta name="next-head-count" content="7"/><link rel="preload" href="/blog/_next/static/css/3aa9fac633eeab01.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/3aa9fac633eeab01.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog/_next/static/chunks/webpack-2c085de5ec1f2737.js" defer=""></script><script src="/blog/_next/static/chunks/framework-6e4ba497ae0c8a3f.js" defer=""></script><script src="/blog/_next/static/chunks/main-9fddf30fd6f89499.js" defer=""></script><script src="/blog/_next/static/chunks/pages/_app-12f7e1c190babb18.js" defer=""></script><script src="/blog/_next/static/chunks/919-231013f5e47261ba.js" defer=""></script><script src="/blog/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-3d0d7b5b21b5a35b.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_buildManifest.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_ssgManifest.js" defer=""></script><script src="/blog/_next/static/sAih_aVMsyb7DL7MOSAgG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="flex flex-col min-h-screen"><header><nav class="fixed w-full py-3 z-20 text-center font-semibold bg-gray-800" aria-label="Header navigation"><a class="px-5 py-3 no-underline font-mono tracking-tight" href="/blog/"><span class="text-xs text-gray-100 duration-1000">jamband<!-- -->/</span><span class="text-pink-500 opacity-80 duration-1000">blog</span></a></nav></header><main class="flex-grow container mx-auto pt-28 pb-10"><div class="style_initial__lfW24" role="status"></div><div><article><header class="mb-8"><h1 class="mb-10">Laravel as an API backend でのプロジェクトの構成について少しだけ考えてみる</h1><div class="italic text-right text-sm text-gray-400"><time dateTime="2021-02-15">Feb 15, 2021</time></div></header><div class="post"><h2>はじめに</h2>
<p>Laravel で Backend な API を作る機会があったので、ついでにプロジェクトの構成についても「少しだけ」 考えてみた。</p>
<p>あまりやり過ぎると初学者には難しすぎるし、何もやらなければすぐ破綻する。プロジェクトと採用するフレームワークの特徴を掴んで、良い感じの落とし所を探っていく。</p>
<h2>環境</h2>
<ul>
<li>PHP 7.4.x</li>
<li>Laravel 8.x</li>
</ul>
<h2>ディレクトリ構成</h2>
<p>GitHub にサンプルを用意したので、それを参考にしてほしい。</p>
<p><a href="https://github.com/jamband/api.cameloz" target="_blank" rel="nofollow noopener noreferrer">GitHub: jamband/api.cameloz</a></p>
<p>とりあえずはまず Laravel が提供しているアプリケーションのディレクトリ構成にできる限り従い、「その中でやれることをやる」という形でいく。それでも何か難しい問題が発生した場合は、その時に考え、その時に対応する。</p>
<h2>ルーティング</h2>
<p>まずは API の入り口であるルーター周り。ここではほぼほぼ何もやらない。各種ミドルウェアなどの割り当てもここではやらない。</p>
<div class="remark-highlight"><pre data-file="app/Providers/RouteServiceProvider.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Providers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Providers<span class="token punctuation">\</span>RouteServiceProvider</span> <span class="token keyword">as</span> ServiceProvider<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">RouteServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">createGroups</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'projects'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'tasks'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'task_priorities'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">createGroups</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$groups</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$groups</span> <span class="token keyword">as</span> <span class="token variable">$group</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token variable">$group</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">group</span><span class="token punctuation">(</span>
                <span class="token function">base_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'routes/'</span><span class="token operator">.</span><span class="token variable">$group</span><span class="token operator">.</span><span class="token string single-quoted-string">'.php'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>グループ事にファイルを分ける。それだけやっておく。こうすることによってエンドポイントが増えていってもある程度までは対応できる。</p>
<p>以下は projects グループのルート:</p>
<div class="remark-highlight"><pre data-file="routes/projects.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> App\Http\Controllers\Project\<span class="token punctuation">{</span>
    CreateProject<span class="token punctuation">,</span>
    DeleteProject<span class="token punctuation">,</span>
    GetProject<span class="token punctuation">,</span>
    GetProjects<span class="token punctuation">,</span>
    UpdateProject<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'project'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'[\d]+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token scope">GetProjects<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'{project}'</span><span class="token punctuation">,</span> <span class="token scope">GetProject<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token scope">CreateProject<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'{project}'</span><span class="token punctuation">,</span> <span class="token scope">UpdateProject<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'{project}'</span><span class="token punctuation">,</span> <span class="token scope">DeleteProject<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>良い感じにコントローラに繋げるために、シングルアクションコントローラを使うようにする。定義元のコントローラにジャンプすれば、そこには一つのエンドポイントの処理のみが書いてある。他のアクションのことは一旦忘れる。目の前のアクションに集中する。という構成。</p>
<h2>ミドルウェア</h2>
<p>グローバルなミドルウェアなどは以下で構成する:</p>
<div class="remark-highlight"><pre data-file="app/Http/Kernel.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>PreventRequestsDuringMaintenance</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>TrimStrings</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>TrustHosts</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>TrustProxies</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Fruitcake<span class="token punctuation">\</span>Cors<span class="token punctuation">\</span>HandleCors</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Kernel</span> <span class="token keyword">as</span> HttpKernel<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>ConvertEmptyStringsToNull</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>ValidatePostSize</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Routing<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>SubstituteBindings</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Kernel</span> <span class="token keyword">extends</span> <span class="token class-name">HttpKernel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$middleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token scope">ConvertEmptyStringsToNull<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">HandleCors<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">PreventRequestsDuringMaintenance<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">TrimStrings<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">TrustHosts<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">TrustProxies<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token scope">ValidatePostSize<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'bindings'</span> <span class="token operator">=></span> <span class="token scope">SubstituteBindings<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$middlewarePriority</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token scope">SubstituteBindings<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>$routeMiddleware は本当は短縮キーを使用せずにコントローラに直接書きたかったが (定義元にジャンプできるので)、オプション等が必要なミドルウェアを割り当てる場合に上手く書くことができなかったため諦めた。</p>
<h2>コントローラ</h2>
<p>コントローラの構成は以下:</p>
<ul>
<li>ベースのコントローラ</li>
<li>ベースのコントローラを継承したグループのコントローラ</li>
<li>グループのコントローラを継承したシングルアクションコントローラ</li>
</ul>
<p>この 3 段階構成でいく。ベースのコントローラとグループのコントローラには極力何も書かない。まずはシングルアクションコントローラに具体的な処理を書くようにし、どうしても必要な場合にグループのコントローラに書く。それでも問題がある場合にベースのコントローラに書く。という構成。</p>
<p>こうすることによってどのエンドポイントでどのようなミドルウェアが割当たっているかなどの見通しが良くなる。</p>
<p>以下はこの 3 段階構成の例:</p>
<div class="remark-highlight"><pre data-file="app/Http/Controllers/Controller.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Routing<span class="token punctuation">\</span>Controller</span> <span class="token keyword">as</span> BaseController<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Controller</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="app/Http/Controllers/Project/Controller.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers<span class="token punctuation">\</span>Project</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers<span class="token punctuation">\</span>Controller</span> <span class="token keyword">as</span> BaseController<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Controller</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre data-file="app/Http/Controllers/Project/DeleteProject.php" class="language-php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers<span class="token punctuation">\</span>Project</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Project</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">DeleteProject</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'bindings'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Project</span> <span class="token variable">$project</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Response</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$project</span><span class="token operator">-></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">noContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>例はシンプルだが、実際には認可処理であったり、あーだこーだいろいろなものが入りこんでくるので、そういった場合にいかに見通しがよくなるように構成していくかというのが重要かなと思う。</p>
<h2>認可とバリデーション</h2>
<p>コントローラを小さく保つために <a href="https://laravel.com/docs/8.x/validation#form-request-validation" target="_blank" rel="nofollow noopener noreferrer">Form Request Validation</a> を使う。一つのアクションに対して一つの Form Request を持つようにする。共通の Form Request などは却って複雑に成りかねないので持たせない。</p>
<h2>テスト</h2>
<p>プロジェクトが Backend な API であること、また Laravel では HTTP テストがとても書きやすく軽いということ (Laravel 8.25.x 以降ではテストの並列実行も可能になった)、などの特徴を踏まえて、API の出口である HTTP テストを充実させるという方向でいく。</p>
<p>このような経緯に至った理由としては、とにかくForm Request のテストが非常に書きにくく、ある時点になると負債になりかねないと感じたから。</p>
<p>また、API リソースなども単体ではテストは書かず、HTTP テストで補う。ただ、モデルなどのテストはちゃんと書く。そういう構成にした。</p>
<h2>まとめ</h2>
<p>とりあえずこのような構成で始めてみる。いずれ問題が発生するかもしれないが、何か難しい問題が発生しつつある場合は、その時に考え、その時に対応する。そのために小さな準備を開発初期の段階でやっておく。</p>
<h2>参考リンク</h2>
<ul>
<li><a href="https://qiita.com/nunulk/items/5297cce4545ac3c16822" target="_blank" rel="nofollow noopener noreferrer">Laravel で Request, UseCase, Resource を使いコントロールフローをシンプルにする - Qiita</a></li>
<li><a href="https://zenn.dev/mpyw/articles/ce7d09eb6d8117" target="_blank" rel="nofollow noopener noreferrer">5年間 Laravel を使って辿り着いた，全然頑張らない「なんちゃってクリーンアーキテクチャ」という落としどころ</a></li>
</ul>
<h2>関連リンク</h2>
<ul>
<li><a href="https://github.com/jamband/api.cameloz" target="_blank" rel="nofollow noopener noreferrer">GitHub: jamband/api.cameloz</a></li>
</ul>
</div><p class="mt-16 text-center"><a class="px-5 py-3 font-semibold" href="/blog/">Home</a></p></article></div></main><div class="mb-3 font-semibold text-center text-xs text-gray-500">© 2022 Tomoki Morita</div><footer class="py-3 text-center font-semibold bg-gray-800"><nav class="text-sm" aria-label="Footer navigation"><a class="px-5 py-3" href="/blog/about/">About</a><a class="px-5 py-3" href="/blog/contact/">Contact</a></nav></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Laravel as an API backend でのプロジェクトの構成について少しだけ考えてみる","date":"2021-02-15","tags":["laravel"],"year":"2021","month":"02","slug":"structure-of-the-project-with-laravel-as-an-api-backend","content":"\u003ch2\u003eはじめに\u003c/h2\u003e\n\u003cp\u003eLaravel で Backend な API を作る機会があったので、ついでにプロジェクトの構成についても「少しだけ」 考えてみた。\u003c/p\u003e\n\u003cp\u003eあまりやり過ぎると初学者には難しすぎるし、何もやらなければすぐ破綻する。プロジェクトと採用するフレームワークの特徴を掴んで、良い感じの落とし所を探っていく。\u003c/p\u003e\n\u003ch2\u003e環境\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003ePHP 7.4.x\u003c/li\u003e\n\u003cli\u003eLaravel 8.x\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eディレクトリ構成\u003c/h2\u003e\n\u003cp\u003eGitHub にサンプルを用意したので、それを参考にしてほしい。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/jamband/api.cameloz\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub: jamband/api.cameloz\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eとりあえずはまず Laravel が提供しているアプリケーションのディレクトリ構成にできる限り従い、「その中でやれることをやる」という形でいく。それでも何か難しい問題が発生した場合は、その時に考え、その時に対応する。\u003c/p\u003e\n\u003ch2\u003eルーティング\u003c/h2\u003e\n\u003cp\u003eまずは API の入り口であるルーター周り。ここではほぼほぼ何もやらない。各種ミドルウェアなどの割り当てもここではやらない。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Providers/RouteServiceProvider.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProviders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProviders\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e ServiceProvider\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eRouteServiceProvider\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eServiceProvider\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eboot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eroutes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreateGroups\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n                \u003cspan class=\"token string single-quoted-string\"\u003e'projects'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token string single-quoted-string\"\u003e'tasks'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token string single-quoted-string\"\u003e'task_priorities'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003ecreateGroups\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword type-hint\"\u003earray\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$groups\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword return-type\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eforeach\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$groups\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$group\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eprefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$group\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"token function\"\u003ebase_path\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'routes/'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$group\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eグループ事にファイルを分ける。それだけやっておく。こうすることによってエンドポイントが増えていってもある程度までは対応できる。\u003c/p\u003e\n\u003cp\u003e以下は projects グループのルート:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"routes/projects.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e App\\Http\\Controllers\\Project\\\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    CreateProject\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    DeleteProject\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    GetProject\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    GetProjects\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    UpdateProject\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSupport\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFacades\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003epattern\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'project'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'[\\d]+'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eGetProjects\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'{project}'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eGetProject\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003epost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eCreateProject\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'{project}'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eUpdateProject\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eRoute\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003edelete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'{project}'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eDeleteProject\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e良い感じにコントローラに繋げるために、シングルアクションコントローラを使うようにする。定義元のコントローラにジャンプすれば、そこには一つのエンドポイントの処理のみが書いてある。他のアクションのことは一旦忘れる。目の前のアクションに集中する。という構成。\u003c/p\u003e\n\u003ch2\u003eミドルウェア\u003c/h2\u003e\n\u003cp\u003eグローバルなミドルウェアなどは以下で構成する:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Kernel.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003ePreventRequestsDuringMaintenance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eTrimStrings\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eTrustHosts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eTrustProxies\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eFruitcake\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eCors\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHandleCors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e HttpKernel\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eConvertEmptyStringsToNull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFoundation\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eValidatePostSize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRouting\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMiddleware\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSubstituteBindings\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eKernel\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpKernel\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eConvertEmptyStringsToNull\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eHandleCors\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003ePreventRequestsDuringMaintenance\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eTrimStrings\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eTrustHosts\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eTrustProxies\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eValidatePostSize\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$routeMiddleware\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'bindings'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token scope\"\u003eSubstituteBindings\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$middlewarePriority\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003eSubstituteBindings\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e$routeMiddleware は本当は短縮キーを使用せずにコントローラに直接書きたかったが (定義元にジャンプできるので)、オプション等が必要なミドルウェアを割り当てる場合に上手く書くことができなかったため諦めた。\u003c/p\u003e\n\u003ch2\u003eコントローラ\u003c/h2\u003e\n\u003cp\u003eコントローラの構成は以下:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eベースのコントローラ\u003c/li\u003e\n\u003cli\u003eベースのコントローラを継承したグループのコントローラ\u003c/li\u003e\n\u003cli\u003eグループのコントローラを継承したシングルアクションコントローラ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこの 3 段階構成でいく。ベースのコントローラとグループのコントローラには極力何も書かない。まずはシングルアクションコントローラに具体的な処理を書くようにし、どうしても必要な場合にグループのコントローラに書く。それでも問題がある場合にベースのコントローラに書く。という構成。\u003c/p\u003e\n\u003cp\u003eこうすることによってどのエンドポイントでどのようなミドルウェアが割当たっているかなどの見通しが良くなる。\u003c/p\u003e\n\u003cp\u003e以下はこの 3 段階構成の例:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Controllers/Controller.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eControllers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eRouting\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eController\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e BaseController\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eController\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBaseController\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Controllers/Project/Controller.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eControllers\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eControllers\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eController\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e BaseController\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eController\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBaseController\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003e\u003cspan class=\"token keyword\"\u003eparent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"app/Http/Controllers/Project/DeleteProject.php\" class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003edeclare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrict_types\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eControllers\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eApp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eModels\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eProject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eIlluminate\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eHttp\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name-definition class-name\"\u003eDeleteProject\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eController\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token scope\"\u003e\u003cspan class=\"token keyword\"\u003eparent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"token string single-quoted-string\"\u003e'bindings'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003e__invoke\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eProject\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$project\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name return-type\"\u003eResponse\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$project\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003edelete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eresponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enoContent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e例はシンプルだが、実際には認可処理であったり、あーだこーだいろいろなものが入りこんでくるので、そういった場合にいかに見通しがよくなるように構成していくかというのが重要かなと思う。\u003c/p\u003e\n\u003ch2\u003e認可とバリデーション\u003c/h2\u003e\n\u003cp\u003eコントローラを小さく保つために \u003ca href=\"https://laravel.com/docs/8.x/validation#form-request-validation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eForm Request Validation\u003c/a\u003e を使う。一つのアクションに対して一つの Form Request を持つようにする。共通の Form Request などは却って複雑に成りかねないので持たせない。\u003c/p\u003e\n\u003ch2\u003eテスト\u003c/h2\u003e\n\u003cp\u003eプロジェクトが Backend な API であること、また Laravel では HTTP テストがとても書きやすく軽いということ (Laravel 8.25.x 以降ではテストの並列実行も可能になった)、などの特徴を踏まえて、API の出口である HTTP テストを充実させるという方向でいく。\u003c/p\u003e\n\u003cp\u003eこのような経緯に至った理由としては、とにかくForm Request のテストが非常に書きにくく、ある時点になると負債になりかねないと感じたから。\u003c/p\u003e\n\u003cp\u003eまた、API リソースなども単体ではテストは書かず、HTTP テストで補う。ただ、モデルなどのテストはちゃんと書く。そういう構成にした。\u003c/p\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eとりあえずこのような構成で始めてみる。いずれ問題が発生するかもしれないが、何か難しい問題が発生しつつある場合は、その時に考え、その時に対応する。そのために小さな準備を開発初期の段階でやっておく。\u003c/p\u003e\n\u003ch2\u003e参考リンク\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/nunulk/items/5297cce4545ac3c16822\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLaravel で Request, UseCase, Resource を使いコントロールフローをシンプルにする - Qiita\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zenn.dev/mpyw/articles/ce7d09eb6d8117\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e5年間 Laravel を使って辿り着いた，全然頑張らない「なんちゃってクリーンアーキテクチャ」という落としどころ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e関連リンク\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamband/api.cameloz\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGitHub: jamband/api.cameloz\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2021","month":"02","slug":"structure-of-the-project-with-laravel-as-an-api-backend"},"buildId":"sAih_aVMsyb7DL7MOSAgG","assetPrefix":"/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>