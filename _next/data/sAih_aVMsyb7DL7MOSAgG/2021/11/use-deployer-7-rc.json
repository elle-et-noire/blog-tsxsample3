{"pageProps":{"post":{"title":"Deployer の 7.0 RC 版を使ってみる","date":"2021-11-28","tags":["deployment","php"],"year":"2021","month":"11","slug":"use-deployer-7-rc","content":"<h2>はじめに</h2>\n<p>PHP のバージョン 8.1 が 25 Nov 2021 にリリースされ、7.3 系のセキュリティーサポートも 6 Dec 2021 で終了する。それに従って、自分が管理している PHP のパッケージなども最低バージョンを 7.4 にし 8.1 もサポートした。</p>\n<p>また、自分は各言語の最新バージョンの 1 つ前のバージョンをローカルに持っておくという基本ルールがあって (例外もあるが)、Node.js の場合は LTS バージョンで区切って現時点では 14.x 系、PHP はマイナーバージョンで区切って 8.0 系になった。</p>\n<p>ここで一つ問題が出てきて、PHP のデプロイツールである Deployer の現時点の最新バージョン 6.8 系が PHP の 8.x 系をサポートしていないことが判明。Deployer はローカルの Composer global で管理していて、ローカルの PHP のバージョンに依存しているので、さてどうしようかとなった。</p>\n<p>Deployer は現在開発中の 7.0 系があって、そのバージョンは PHP 8.1 までサポートしている感じだったので、現時点ではまだ RC 版ではあるのだが、個人サイトで実験的に試すなら問題ないでしょ、ということで、よし使ってみようということになった。</p>\n<h2>環境</h2>\n<ul>\n<li>PHP 8.0</li>\n<li>Deloyer 7.0 RC</li>\n</ul>\n<h2>Deployer 6.x と 7.x の違い</h2>\n<p>Deployer の 6.x 系と 7.x 系の PHP のサポートバージョンの違いは上記に書いてあるとおり。あとは <a href=\"https://deployer.org/docs/7.x/UPGRADE\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Upgrade from 6.x to 7.x | Deployer</a> を見ながら対応していく。</p>\n<p>公式ドキュメントを見る限り 7.x 系のドキュメントはまだまだ少なく、RC 版であることから、現時点で 6.x 系から 7.x 系への移行はまだおすすめできない。</p>\n<p>そんな状況ではあるのだが、7.x 系の特徴としては以下。</p>\n<ul>\n<li>デプロイ用のスクリプトを YAML でも記述できるようになった</li>\n<li>Deployer 専用の GitHub Action を使って git push 時にデプロイできるようになった</li>\n<li>PHP のフレームワーク関連ではない recipe もコアに contrib という名前で入った</li>\n</ul>\n<p>その他にもいろいろあると思うが、確認しきれていない。</p>\n<h2>デプロイの準備</h2>\n<p>では、実際に <a href=\"https://plusarchive.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PlusArchive</a> という個人サイトを例にデプロイしてみる。まずは準備をする。</p>\n<p>構成的には以下。</p>\n<ul>\n<li><a href=\"https://github.com/jamband/api.plusarchive.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">api.plusarchive.com</a> というバックエンドのプロジェクトが GitHub の public レポジトリとしてある</li>\n<li><a href=\"https://github.com/jamband/plusarchive.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">plusarchive.com</a> というフロントエンドのプロジェクトが GitHub の public レポジトリとしてある</li>\n<li><a href=\"https://plusarchive.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PlusArchive</a> はさくらの VPS で管理している</li>\n<li>ssh で PlusArchive サーバと通信できるようになっている</li>\n<li>Deployer は各プロジェクト毎に Composer でローカルにインストールして管理する</li>\n<li>GitHub Action による自動デプロイはしない</li>\n<li>デプロイ用スクリプトは PHP で記述する</li>\n</ul>\n<p>注意点としては、基本的に上記の 2 つのプロジェクトとは別に任意の場所にディレクトリを切って、そこでデプロイ作業を行う (リポジトリとは切り離して管理する)。</p>\n<p>api.plusarchive.com のデプロイの準備 (Deployer 7.x 系はまだ RC 版なので決め打ち):</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> /path/to/plusarchive.com/deploy/api.plusarchive.com\n<span class=\"token function\">composer</span> require --dev <span class=\"token string\">\"deployer/deployer:7.0.0-rc3\"</span>\n<span class=\"token function\">touch</span> deploy.php\n</code></pre></div>\n<p>api.plusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):</p>\n<div class=\"remark-highlight\"><pre data-file=\"deploy.php\" class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">declare</span><span class=\"token punctuation\">(</span>strict_types<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Deployer</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">require</span> <span class=\"token string single-quoted-string\">'recipe/composer.php'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'repository'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'https://github.com/jamband/api.plusarchive.com.git'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'keep_releases'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'shared_dirs'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'runtime'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'writable_dirs'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'runtime'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'clear_paths'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">host</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'plusarchive.com'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'remote_user'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'port'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'labels'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'stage'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'prod'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'branch'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'main'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'deploy_path'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'/xxx/xxx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>api.plusarchive.com は PHP の Yii Framework 2 で書かれているため shared_dirs や writable_dirs で runtime を指定する。実際はデータベースのマイグレーションコマンドなども実行する必要があるのだが、このプロジェクトでは使っていないので書いてない。</p>\n<p>また Deployer は各フレームワークなどを想定して、それ専用の <a href=\"https://deployer.org/docs/7.x/recipe/common\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">recipe</a> を持っているので、使えそうであれば使ってもいいわけだが、プロジェクトによっていろいろ細かな構成の違いなどがあったりするので、実際問題わりと使いづらい。ただ参考にはできるのでコードの詳細を見ながら 7.x の雰囲気を味わっておく。</p>\n<p>plusarchive.com のデプロイの準備:</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> /path/to/plusarchive.com/deploy/plusarchive.com\n<span class=\"token function\">composer</span> require --dev <span class=\"token string\">\"deployer/deployer:7.0.0-rc3\"</span>\n<span class=\"token function\">touch</span> deploy.php\n</code></pre></div>\n<p>plusarchive.com のデプロイ用スクリプトは以下 (xxx や 123 は伏字):</p>\n<div class=\"remark-highlight\"><pre data-file=\"deploy.php\" class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">declare</span><span class=\"token punctuation\">(</span>strict_types<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Deployer</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">require</span> <span class=\"token string single-quoted-string\">'recipe/common.php'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">require</span> <span class=\"token string single-quoted-string\">'contrib/yarn.php'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'repository'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'https://github.com/jamband/plusarchive.com.git'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'keep_releases'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'clear_paths'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">host</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'plusarchive.com'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'remote_user'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'port'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'labels'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'stage'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'prod'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'branch'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'main'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'deploy_path'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'/xxx/xxx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'deploy:update_code'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'yarn:install'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'yarn:build'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cd {{release_path}} &#x26;&#x26; yarn build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'pm2:start'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cd {{deploy_path}} &#x26;&#x26; pm2 startOrRestart ecosystem.config.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'deploy'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string single-quoted-string\">'deploy:prepare'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string single-quoted-string\">'yarn:build'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string single-quoted-string\">'pm2:start'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string single-quoted-string\">'deploy:publish'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>plusarchive.com は Yarn + Nuxt + PM2 の構成なので上記のような感じになっている。</p>\n<h2>デプロイする</h2>\n<p>api.plusarchive.com のデプロイ用コマンドの作成:</p>\n<div class=\"remark-highlight\"><pre data-file=\"/path/to/plusarchive.com/deploy/api.plusarchive.com/composer.json\" class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"require\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"php\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^8.0\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"require-dev\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"deployer/deployer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7.0.0-rc3\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"prepare\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@composer install --quiet\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep deploy stage=prod\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"releases\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep releases\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"unlock\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep deploy:unlock\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"clean\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf vendor\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>plusarchive.com のデプロイ用コマンドの作成 (上記と全く同じ):</p>\n<div class=\"remark-highlight\"><pre data-file=\"/path/to/plusarchive.com/deploy/plusarchive.com/composer.json\" class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"require\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"php\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^8.0\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"require-dev\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"deployer/deployer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7.0.0-rc3\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"prepare\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@composer install --quiet\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep deploy stage=prod\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"releases\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep releases\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"unlock\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dep deploy:unlock\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"clean\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf vendor\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>デプロイは Composer のコマンドを経由して行う。流れ的には以下。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">cd /path/to/plusarchive.com/deploy/api.plusarchive.com\ncomposer run prepare\ncomposer run deploy\ncomposer run clean\n\ncd /path/to/plusarchive.com/deploy/plusarchive.com\ncomposer run prepare\ncomposer run deploy\ncomposer run clean</code></pre></div>\n<p>何かしらの問題があり途中で止まった場合 lock されるので unlock コマンドを用意しておき、デプロイされたプロジェクトの履歴を見るために releases も用意しておく。</p>\n<h2>まとめ</h2>\n<p>わりと雑で少しめんどくさいデプロイ方法ではあるが、問題なく動いてはいるのでとりあえず良しとする。</p>\n<p>今回のデプロイ方法はただの一例であって、このような方法ではなく、もっと洗練された方法があると思うので、Deployer の 7.x の安定版のリリースを待ちつつ、少しずつ改善していきたい。</p>\n<h2>関連リンク</h2>\n<ul>\n<li><a href=\"https://deployer.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Deployer</a></li>\n</ul>\n"}},"__N_SSG":true}